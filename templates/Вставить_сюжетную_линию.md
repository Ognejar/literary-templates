<%*
try {
    // 1. Определяем путь к проекту
    let projectRootPath = '';
    const configFileName = 'Настройки_мира.md';
    const allMarkdownFiles = app.vault.getMarkdownFiles();

    // Начнем с текущей папки, где Templater запускается
    let currentCheckPath = tp.file.folder(true);

    // Поднимаемся вверх по папкам, ища Настройки_мира.md
    while (currentCheckPath && currentCheckPath !== '/') {
        const potentialConfigPath = `${currentCheckPath}/${configFileName}`;
        if (app.vault.getAbstractFileByPath(potentialConfigPath)) {
            projectRootPath = currentCheckPath;
            break;
        }
        const lastSlashIndex = currentCheckPath.lastIndexOf('/');
        currentCheckPath = lastSlashIndex > 0 ? currentCheckPath.substring(0, lastSlashIndex) : '';
    }

    // Если не найдено по текущему пути, попробуем найти из всех файлов
    if (!projectRootPath) {
        const configFiles = allMarkdownFiles.filter(f => f.basename === configFileName);
        if (configFiles.length > 0) {
            projectRootPath = configFiles[0].parent.path;
        } else {
            throw new Error(`Файл "${configFileName}" не найден. Убедитесь, что он существует в корневой папке вашего проекта.`);
        }
    }

    // 2. Читаем сюжетные линии
    const plotLinesFile = `${projectRootPath}/Сюжетные_линии.md`;
    
    if (!app.vault.getAbstractFileByPath(plotLinesFile)) {
        new Notice(`Файл сюжетных линий не найден: ${plotLinesFile}`);
        throw new Error("Сначала создайте файл Сюжетные_линии.md в корне проекта");
    }

    const plotLinesContent = await app.vault.adapter.read(plotLinesFile);
    const plotLines = [];
    const lines = plotLinesContent.split('\n');
    let currentTheme = null;
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (line.startsWith('## Тема')) {
            const match = line.match(/## Тема(\d+) - (.+)/);
            if (match) {
                currentTheme = {
                    id: match[1],
                    name: match[2],
                    description: ''
                };
            }
        } else if (line.startsWith('Описание:') && currentTheme) {
            currentTheme.description = line.replace('Описание:', '').trim();
            plotLines.push(currentTheme);
            currentTheme = null;
        }
    }

    if (plotLines.length === 0) {
        throw new Error("В файле сюжетных линий не найдено ни одной темы");
    }

    // 3. Выбор сюжетной линии
    const plotLineChoices = plotLines.map(line => `${line.name} - ${line.description}`);
    const plotLineIndices = plotLines.map((_, index) => index);
    const selectedPlotLineIndex = await tp.system.suggester(plotLineChoices, plotLineIndices);
    
    if (selectedPlotLineIndex === undefined) {
        throw new Error("Сюжетная линия не выбрана");
    }

    const selectedPlotLine = plotLines[selectedPlotLineIndex];

    // 4. Выбор уровня важности
    const degrees = [
        { name: "Прямая", value: "прямая", description: "Глава напрямую развивает сюжетную линию" },
        { name: "Связанная", value: "связанная", description: "Глава косвенно связана с сюжетной линией" },
        { name: "Фоновая", value: "фоновая", description: "Глава создает фон для сюжетной линии" }
    ];

    const degreeChoices = degrees.map(d => `${d.name} - ${d.description}`);
    const degreeIndices = degrees.map((_, index) => index);
    const selectedDegreeIndex = await tp.system.suggester(degreeChoices, degreeIndices);
    
    if (selectedDegreeIndex === undefined) {
        throw new Error("Уровень важности не выбран");
    }

    const selectedDegree = degrees[selectedDegreeIndex];

    // 5. Описание роли в сюжетной линии
    const roleDescription = await tp.system.prompt(`Опишите роль этой главы в сюжетной линии "${selectedPlotLine.name}" (${selectedDegree.name})`) || "";

    // 6. Формируем ссылку на сюжетную линию с уникальным путём
    const plotLineLink = `[[${plotLinesFile}#Тема${selectedPlotLine.id} - ${selectedPlotLine.name}|${selectedPlotLine.name}]]`;
    
    // 7. Создаем текст для вставки
    let insertText = `- **${plotLineLink}** (${selectedDegree.value})`;
    if (roleDescription.trim()) {
        insertText += `: ${roleDescription}`;
    }
    insertText += "\n";

    // 8. Вставляем в текущий файл
    tR += insertText;

    new Notice(`Добавлена сюжетная линия: ${selectedPlotLine.name} (${selectedDegree.value})`);

} catch (error) {
    new Notice(`Ошибка: ${error.message}`);
    console.error(error);
}
%> 