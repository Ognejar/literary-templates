<%*
try {
    // 1. Определяем путь к проекту
    let projectRootPath = '';
    const configFileName = 'Настройки_мира.md';
    const allMarkdownFiles = app.vault.getMarkdownFiles();

    let currentCheckPath = tp.file.folder(true);
    while (currentCheckPath && currentCheckPath !== '/') {
        const potentialConfigPath = `${currentCheckPath}/${configFileName}`;
        if (app.vault.getAbstractFileByPath(potentialConfigPath)) {
            projectRootPath = currentCheckPath;
            break;
        }
        const lastSlashIndex = currentCheckPath.lastIndexOf('/');
        currentCheckPath = lastSlashIndex > 0 ? currentCheckPath.substring(0, lastSlashIndex) : '';
    }

    if (!projectRootPath) {
        const configFiles = allMarkdownFiles.filter(f => f.basename === configFileName);
        if (configFiles.length > 0) {
            projectRootPath = configFiles[0].parent.path;
        } else {
            throw new Error(`Файл "${configFileName}" не найден.`);
        }
    }

    // 2. СОЗДАНИЕ МОНСТРА
    const name = await tp.system.prompt("Название монстра");
    if (!name?.trim()) throw new Error("Название обязательно!");

    const cleanName = name.trim().replace(/[^а-яА-ЯёЁ\w\s-.]/g, '').replace(/\.md$/i, '');
    const baseFileName = cleanName.replace(/\s+/g, '_');

    // 3. СОХРАНЕНИЕ В ПАПКУ "Монстры"
    const monstersFolder = `${projectRootPath}/Монстры`;
    if (!app.vault.getAbstractFileByPath(monstersFolder)) {
        await app.vault.createFolder(monstersFolder);
    }

    let newFullFileName = baseFileName;
    let targetFilePath = `${monstersFolder}/${newFullFileName}`;
    let currentFolder = tp.file.folder(true);
    let currentPathFile = `${currentFolder}/${newFullFileName}`;
    let counter = 2;

    if (app.vault.getAbstractFileByPath(currentPathFile)) {
        new Notice(`В текущей папке уже есть файл с именем: ${currentPathFile}`);
        while (app.vault.getAbstractFileByPath(`${currentFolder}/${baseFileName}_${counter}`)) {
            counter++;
        }
        newFullFileName = `${baseFileName}_${counter}`;
        currentPathFile = `${currentFolder}/${newFullFileName}`;
        targetFilePath = `${monstersFolder}/${newFullFileName}`;
        new Notice(`Будет использовано имя: ${newFullFileName}`);
    }

    new Notice(`Проверка файла: ${targetFilePath}`);
    console.log(`[Новый_монстр] Проверка файла: ${targetFilePath}`);

    let fileExists = app.vault.getAbstractFileByPath(targetFilePath);
    let fileToOpen = targetFilePath;
    counter = 2;
    if (fileExists) {
        const choice = await tp.system.suggester([
            `Открыть существующий (${newFullFileName})`,
            `Создать новый с нумерацией (_2, _3...)`
        ], ["open", "new"]);
        if (choice === "open") {
            new Notice(`Открываю существующий файл: ${targetFilePath}`);
            const file = app.vault.getAbstractFileByPath(targetFilePath);
            if (file) {
                await app.workspace.getLeaf().openFile(file);
            }
            return;
        } else {
            while (app.vault.getAbstractFileByPath(`${monstersFolder}/${baseFileName}_${counter}`)) {
                counter++;
            }
            newFullFileName = `${baseFileName}_${counter}`;
            fileToOpen = `${monstersFolder}/${newFullFileName}`;
            new Notice(`Создаю файл: ${fileToOpen}`);
        }
    }

    await tp.file.move(fileToOpen);
    if (tp.file.title !== newFullFileName) {
        await tp.file.rename(newFullFileName);
    }

    // 4. ЗАПОЛНЕНИЕ ДАННЫХ
    const now = tp.date.now("YYYY-MM-DD");
    const type = await tp.system.suggester([
        "Дракон", "Гоблин", "Орк", "Тролль", "Вампир", "Оборотень", "Призрак", "Зомби", "Демон", "Элементаль", "Другое"
    ], [
        "Дракон", "Гоблин", "Орк", "Тролль", "Вампир", "Оборотень", "Призрак", "Зомби", "Демон", "Элементаль", "Другое"
    ]);
    
    const size = await tp.system.suggester([
        "Крошечный", "Маленький", "Средний", "Большой", "Огромный", "Гигантский"
    ], [
        "Крошечный", "Маленький", "Средний", "Большой", "Огромный", "Гигантский"
    ]);
    
    const intelligence = await tp.system.suggester([
        "Животное", "Примитивное", "Среднее", "Высокое", "Гениальное"
    ], [
        "Животное", "Примитивное", "Среднее", "Высокое", "Гениальное"
    ]);
    
    const alignment = await tp.system.suggester([
        "Добрый", "Нейтральный", "Злой", "Хаотичный", "Законопослушный"
    ], [
        "Добрый", "Нейтральный", "Злой", "Хаотичный", "Законопослушный"
    ]);
    
    const habitat = await tp.system.prompt("Место обитания:");
    const description = await tp.system.prompt("Описание монстра:");
    const abilities = await tp.system.prompt("Способности (через запятую):") || "";
    const weaknesses = await tp.system.prompt("Слабости (через запятую):") || "";
    const behavior = await tp.system.prompt("Поведение:");
    const featuresInput = await tp.system.prompt("Особенности (через запятую)") || "";

    let abilitiesContent = "";
    abilities.split(',').forEach(f => {
        const trimmed = f.trim();
        if (trimmed) abilitiesContent += `- ${trimmed}\n`;
    });

    let weaknessesContent = "";
    weaknesses.split(',').forEach(f => {
        const trimmed = f.trim();
        if (trimmed) weaknessesContent += `- ${trimmed}\n`;
    });

    let featuresContent = "";
    featuresInput.split(',').forEach(f => {
        const trimmed = f.trim();
        if (trimmed) featuresContent += `- ${trimmed}\n`;
    });
-%>
---
created: "<% now %>"
name: "<% cleanName %>"
aliases: ["<% cleanName %>"]
type: "<% type %>"
size: "<% size %>"
intelligence: "<% intelligence %>"
alignment: "<% alignment %>"
habitat: "<% habitat %>"
tags: [monster, creature, <% type.toLowerCase() %>]
---

# <% cleanName %>

**Тип:** <% type %>  
**Размер:** <% size %>  
**Интеллект:** <% intelligence %>  
**Мировоззрение:** <% alignment %>  
**Место обитания:** [[<% habitat %>]]  

## Описание
<% description %>

## Физические характеристики
- **Размер:** <% size %>
- **Внешний вид:** 
- **Окрас:** 
- **Особые признаки:** 

## Способности
<% abilitiesContent %>

## Слабости
<% weaknessesContent %>

## Поведение
<% behavior %>

## Экология
- **Среда обитания:** [[<% habitat %>]]
- **Питание:** 
- **Размножение:** 
- **Продолжительность жизни:** 
- **Естественные враги:** 

## Социальная структура
- **Организация:** 
- **Иерархия:** 
- **Коммуникация:** 
- **Отношения с другими существами:** 

## История и происхождение
- **Происхождение:** 
- **Исторические упоминания:** 
- **Легенды:** 
- **Эволюция:** 

## Взаимодействие с людьми
- **Отношение к людям:** 
- **Нападения:** 
- **Случаи приручения:** 
- **Использование людьми:** 

## Опасность и угроза
- **Уровень угрозы:** 
- **Методы защиты:** 
- **Рекомендации при встрече:** 
- **Награда за победу:** 

## Автоматические связи
### Места обитания
```dataview
LIST FROM #place
WHERE (
    contains(file.outlinks, [[<% baseFileName %>]]) OR
    contains(file.tags, "<% baseFileName %>") OR
    regexmatch(file.text, "#<% baseFileName %>") OR
    regexmatch(file.text, "\\[\\[<% baseFileName %>(\\||\\]\\])")
) AND file.name != this.file.name
```

### Охотники и герои
```dataview
LIST FROM #people OR #character
WHERE (
    contains(file.outlinks, [[<% baseFileName %>]]) OR
    contains(file.tags, "<% baseFileName %>") OR
    regexmatch(file.text, "#<% baseFileName %>") OR
    regexmatch(file.text, "\\[\\[<% baseFileName %>(\\||\\]\\])")
) AND file.name != this.file.name
```

### Связанные события
```dataview
LIST FROM #event
WHERE (
    contains(file.outlinks, [[<% baseFileName %>]]) OR
    contains(file.tags, "<% baseFileName %>") OR
    regexmatch(file.text, "#<% baseFileName %>") OR
    regexmatch(file.text, "\\[\\[<% baseFileName %>(\\||\\]\\])")
) AND file.name != this.file.name
```

### Связанные артефакты
```dataview
LIST FROM #artifact
WHERE (
    contains(file.outlinks, [[<% baseFileName %>]]) OR
    contains(file.tags, "<% baseFileName %>") OR
    regexmatch(file.text, "#<% baseFileName %>") OR
    regexmatch(file.text, "\\[\\[<% baseFileName %>(\\||\\]\\])")
) AND file.name != this.file.name
```

## Особенности
<% featuresContent %>

<% tp.file.cursor() %>

<%* } catch (error) {
    new Notice(`Ошибка: ${error.message}`);
    console.error(error);
} %> 