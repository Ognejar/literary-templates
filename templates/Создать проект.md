<%*
// 1. Отключаем Banners на время создания
const bannersPlugin = app.plugins.plugins['obsidian-banners'];
const wasBannersEnabled = bannersPlugin?.settings.enabled;
if (bannersPlugin) bannersPlugin.settings.enabled = false;

// 2. Создаем структуру проекта
const projectName = (await tp.system.prompt("Название проекта") || "Новый_Проект").trim();
const safeName = projectName.replace(/\s+/g, '_');
const projectFolder = `${tp.file.folder(true)}/${safeName}`;

// 3. Создаем папки
await app.vault.createFolder(projectFolder);
await app.vault.createFolder(`${projectFolder}/Главы`);

// 4. Создаём файл Настройки_мира.md из шаблона, если он есть
let settingsContent = `# Настройки мира\n\n- [ ] Определить жанр и сеттинг\n- [ ] Описать основные законы мира\n- [ ] Составить карту мира (если нужно)\n- [ ] Описать магию/технологии/особенности\n- [ ] Указать ключевые исторические события\n\n## Краткое описание мира\n\n[Здесь будет описание мира]\n`;
try {
  const templateFile = app.vault.getAbstractFileByPath("Шаблоны/Настройки_мира_образец.md");
  if (templateFile) {
    settingsContent = await app.vault.read(templateFile);
  }
} catch {}
const settingsFile = await app.vault.create(
    `${projectFolder}/Настройки_мира.md`,
    settingsContent
);

// 5. Создаём файл Сюжетные_линии.md
const plotFile = await app.vault.create(
    `${projectFolder}/Сюжетные_линии.md`,
    `# Сюжетные линии\n\n- [ ] Определить основные сюжетные линии\n- [ ] Связать линии с главами\n- [ ] Описать арки персонажей\n\n## Пример:\n- Главная линия: Побег\n- Фоновая линия: Тайна прошлого\n- Персонаж: Жора — путь героя\n`
);

// 6. Создаём основной файл проекта с frontmatter и стандартными задачами
const projectFile = await app.vault.create(
    `${projectFolder}/${safeName}.md`,
    `---\ntype: проект\nname: "${projectName}"\ncreated: "${tp.date.now("YYYY-MM-DD")}"\n---\n\n# ${projectName}\n\n## Управление проектом\n\n- [ ] Определить цели проекта\n- [ ] Составить список глав\n- [ ] Описать ключевых персонажей\n- [ ] Разработать основные сюжетные линии\n- [ ] Настроить шаблоны для глав и сцен\n- [ ] Заполнить Настройки_мира.md\n- [ ] Заполнить Сюжетные_линии.md\n\n## Ссылки\n- [[${safeName}/Настройки_мира|Настройки мира]]\n- [[${safeName}/Сюжетные_линии|Сюжетные линии]]\n- [[${safeName}/Главы|Главы]]\n`
);

// 7. Восстанавливаем Banners
if (bannersPlugin && wasBannersEnabled) {
    setTimeout(() => {
        bannersPlugin.settings.enabled = true;
    }, 1000);
}

// 8. Очистка временных файлов
const cleanUntitled = async () => {
    const files = app.vault.getFiles().filter(f => /^Untitled/i.test(f.name));
    for (const file of files) {
        try {
            await app.vault.delete(file);
        } catch {}
    }
};
await cleanUntitled();
setTimeout(cleanUntitled, 500);

// 9. Открываем проект
setTimeout(async () => {
    try {
        await app.workspace.getLeaf().openFile(projectFile);
    } catch {
        app.workspace.openLinkText(projectFile.basename, "", true);
    }
}, 300);
%>