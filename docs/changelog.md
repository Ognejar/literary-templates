# Журнал изменений

Все значимые изменения в проекте будут документироваться в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и проект следует [Semantic Versioning](https://semver.org/lang/ru/).

## [1.0.1] - 2025-01-09

### Исправлено
- **Критическая ошибка:** `TypeError: Cannot read properties of undefined (reading 'vault')` при загрузке плагина
- **Причина:** Два источника преждевременного обращения к `this.app.vault`:
  1. **Обработчики событий** регистрировались до завершения `await this.loadData()`
  2. **Создание папки** `Шаблоны/sections` также обращалось к `this.app.vault` преждевременно
  3. **Метод `loadData()`** вызывался до полной инициализации `this.app`
- **Решение:** 
  1. ✅ Перенес регистрацию всех обработчиков событий **ПОСЛЕ** `await this.loadData()`
  2. ✅ Переместил создание папки для секций в **конец** метода `onload`
  3. ✅ Добавил проверку существования `this.app.vault` перед вызовом `loadData()`
  4. ✅ Добавил цикл ожидания инициализации `this.app` (до 50 попыток)
  5. ✅ Обернул вызовы `loadData()` в try-catch блоки
  6. ✅ Пересобрал плагин
- **Затронутые файлы:** `main.js` - изменен порядок инициализации в методе `onload`

### Технические детали
- Обработчики `file-open`, `file-menu`, `folder-menu`, `vault.on('create')` теперь регистрируются только после полной инициализации плагина
- Создание папки `Шаблоны/sections` перенесено в конец метода `onload` для избежания преждевременного обращения к `this.app.vault`
- Добавлена проверка `if (!this.app || !this.app.vault)` с циклом ожидания инициализации
- Все вызовы `loadData()` обернуты в try-catch для предотвращения падения плагина
- Исправлена ошибка в карте типов для заклинаний (было `'potion'`, стало `'spell'`)

---

## [1.0.0] - 2024-12-19

### Добавлено
- Создан модальный мастер для артефактов (`ArtifactWizardModal.js`)
- Создан модальный мастер для алхимических рецептов (`AlchemyRecipeWizardModal.js`)
- Добавлена функция создания артефактов (`createArtifact.js`)
- Добавлена функция создания алхимических рецептов (`createAlchemyRecipe.js`)
- Обновлен шаблон артефактов с поддержкой новых полей
- Создан новый шаблон алхимических рецептов
- Включены алхимические рецепты в контекстное меню

### Изменено
- Заменена старая функция `createArtifact` в main.js на новую модульную версию
- Обновлено меню "Магия" - все функции теперь активны

### Исправлено
- Удалена дублированная функция `createArtifact` из main.js

## [2024-12-19] - Завершение системы статусов для всех локаций
### Добавлено
- Система статусов (действует/заброшено/разрушено) для всех типов локаций
- Условное отображение производственных/экономических секций в зависимости от статуса
- Шаги статуса во всех модальных окнах создания локаций
- Поле "Причина" для заброшенных и разрушенных локаций

### Изменено
- Обновлены все шаблоны локаций для поддержки статусов
- Модифицированы все модальные окна для включения шага статуса
- Обновлены функции создания для передачи данных о статусе

### Исправлено
- Условные операторы в шаблонах теперь работают корректно
- Удалены дублированные включения секций
- Исправлены вложенные условные блоки

## [2024-12-19] - Реструктуризация контекстного меню
### Добавлено
- Иерархическая структура меню с подменю
- Группировка команд по категориям
- Разделители между разделами

### Изменено
- Перемещены основные разделы в начало меню
- Перемещены служебные функции в конец
- Улучшена навигация и логика меню

## [2024-12-19] - Команды вставки контента
### Добавлено
- Команда "Вставить TODO" для создания задач в текущем файле
- Команда "Вставить сюжетную линию в сцену" для вставки сюжетных линий
- Парсинг файла Сюжетные_линии.md
- Автоматическое определение типа сущности

### Изменено
- Улучшена функция `getActiveEditor` для безопасной работы с MarkdownView
- Добавлена поддержка различных форматов TODO

## [2024-12-19] - Dataview отчеты в главный файл проекта
### Добавлено
- Отчет "Локации по статусам"
- Отчет "Невыполненные задачи"
- Отчет "Пустые карточки"
- Отчет "Города и провинции"

### Изменено
- Главный файл проекта теперь содержит полезные отчеты для отслеживания прогресса

## [2024-12-19] - Исправление ошибок шаблонов
### Исправлено
- Обработка условных операторов {{#if status == действует}}
- Удаление дублированных включений {{include:sections/История.md}}
- Исправление вложенных условных блоков
- Улучшение обработки include-блоков
- Замена {{else if}} на независимые {{#if}} блоки

## [2024-12-19] - Планирование оптимизации системы шаблонов
### Добавлено
- Анализ текущей системы шаблонов
- Определение повторяющихся секций
- План перехода к include-блокам
- План унификации шаблонов

### Изменено
- Документирован план оптимизации системы шаблонов

## [2024-12-19] - Улучшение интерфейса алхимических рецептов

### Добавлено
- Динамический интерфейс для ввода ингредиентов с возможностью добавления/удаления
- Кнопка "+ Добавить ингредиент" для создания произвольного количества ингредиентов
- Кнопки удаления для каждого ингредиента (кроме последнего)
- Улучшенная валидация с проверкой наличия хотя бы одного ингредиента

### Изменено
- Переработан метод `renderIngredients()` в `AlchemyRecipeWizardModal.js`
- Добавлены методы `renderIngredientsList()` и `updateIngredientsData()`
- Обновлен метод `createRecipe()` для работы с новым форматом ингредиентов
- Улучшена валидация шага ингредиентов

### Исправлено
- Проблема с невозможностью ввода ингредиентов вручную
- Отсутствие справочника ингредиентов больше не является препятствием

## [2025-08-13] - Персонажи и заклинания на HtmlWizardModal; секции и шапка
### Добавлено
- Базовый класс `HtmlWizardModal` теперь используется в `CharacterWizardModal` и `SpellWizardModal` (унификация UI и кнопок)
- Общие секции для персонажей: `Шапка.md`, `Основная_информация.md`, `Описание.md`, `Особенности.md`, `Автоматические_связи.md`

### Изменено
- `Новый_персонаж.md` переведён на include секции и генерацию через `generateFromTemplate`
- В меню активирован пункт «Создать персонажа»
- `CharacterWizardModal` показывает изображение из `Теговые_картинки` с фолбэком: `Персонаж` → `character` → по расе
- `SpellWizardModal` переведён на `HtmlWizardModal` (прогресс-бар, кнопки, стили)

### Исправлено
- Отображение тэгового изображения в шапке через условный блок в `sections/Шапка.md`

## [2025-08-13] - Торговый путь и Фракции
### Добавлено
- Шаблоны: `templates/Торговый_путь.md`, `templates/Новая_фракция.md`.
- Создатели: `creators/createTradeRoute.js`, `creators/createFaction.js` (полные мастера).
- Команды: `create-trade-route`, `create-faction`.
- Меню: торговый путь в «💰 Экономика → 🧾 Торговля», фракции в «👥 Народы».
- Подключение в сборку (`build.php`).

### Исправлено
- `PortWizardModal.js` приведён к единому стандарту `EntityWizardBase`.
- `createPort.js` упрощён и использует новый мастер.

## [2025-08-13] - Система персонажей и квестов
### Добавлено
- **Расширенный шаблон персонажа**: `templates/Новый_персонаж.md` с детальными характеристиками для книги.
- **Мастер персонажа**: `CharacterWizardModal.js` (7 шагов: основное, внешность, характер, прошлое, способности, связи, предпросмотр).
- **Система квестов**: `templates/Новый_квест.md` с целями, наградами, этапами.
- **Мастер квестов**: `creators/createQuest.js` (6 шагов: основное, детали, цели, награды, связи, предпросмотр).
- **Команды**: `create-quest` и пункт меню в «📅 События».
- **Подключение в сборку** (`build.php`).

### Улучшено
- **Система персонажей** теперь включает:
  - Демографические данные (возраст, пол, раса, профессия)
  - Роль в истории (главный герой, антагонист, наставник и т.д.)
  - Детальное описание внешности и характера
  - Происхождение и мотивацию
  - Способности, слабости, снаряжение
  - Связи с миром (локации, организации, события, артефакты)
- **Система квестов** включает:
  - Типы (основной сюжет, побочный, повторяющийся, скрытый)
  - Приоритеты и статусы
  - Цели, условия, этапы выполнения
  - Награды и последствия
  - Временные ограничения
  - Связи с персонажами и миром

## [2025-01-27] - Фиксация правил проекта

### Добавлено
- Раздел «Правила проекта» в `docs/tasktracker.md` с ключевыми правилами разработки, сборки и документации

### Изменено
- Процесс: перед каждым шагом — подтверждение; после каждого шага — обновление документации

### Исправлено
- Уточнения по архитектуре create* (main.js + creators/*.js), сборщику (не удалять create*), копированию `templates/Теговые_картинки/`

## [2025-08-15] - Автозапуск мастеров при создании пустых файлов
### Добавлено
- Настройки автозапуска в `main.js`: `autostartEnabled` (вкл/выкл) и `autostartMode` (`soft`/`auto`).
- Команды: `Автозапуск мастеров при создании файла: вкл/выкл`, `Режим автозапуска мастеров: мягкий/авто`.
- Учет настроек в обработчике `vault.on('create')` для пустых `.md` в `Магия/Зелья|Заклинания|Артефакты|Алхимия`.

### Изменено
- Обработчик автозапуска теперь поддерживает «мягкий запуск» (подтверждение) и «авторежим» (без подтверждения).

### Причина
- Ускорение потока создания сущностей и избавление от лишних кликов при черновом структурировании.

## [2025-01-27] - Анализ и исправление критических ошибок плагина

### Анализ проблемы
**Что произошло:**
1. **Изначально** в `main.js` были функции `create*` и `require('./creators/*.js')`
2. **Я агрессивно убрал все `require()`** и заменил функции на заглушки
3. **`build.php` удалял функции `create*`** из `main.js` как "старые"
4. **Результат**: все функции `create*` исчезли, плагин сломался

**Почему это произошло:**
- Не понимал архитектуру: `build.php` склеивает файлы, `require()` становится ненужным
- Убрал рабочий код без полного понимания последствий
- Не тестировал изменения пошагово

**Урок на будущее:**
- Не убирать рабочий код без полного понимания архитектуры
- Тестировать изменения пошагово, а не все сразу
- Сначала анализировать, потом исправлять

### Исправлено
- **Критическая ошибка `createArtifact is not defined`** - восстановлена правильная архитектура
- **Дублирование файлов управления** - исправлен обработчик создания папок
- **Опечатка в шаблоне Государства.md** - исправлено "Государствo.webp" на "Государство.webp"
- **Теговые картинки** - добавлено копирование папки в build.php

### Технические изменения
- **Восстановлена правильная архитектура**: функции `create*` в `main.js` + функции из `creators/*.js`
- **`build.php` больше не удаляет функции `create*`** из `main.js`
- **Убраны `module.exports`** из `creators/*.js`, функции стали глобальными
- **Функции-обертки** в `main.js` заменяются на реальные функции при сборке
- **Улучшена обработка ошибок** в event handler'ах

## [2025-07-20] - Хранение настроек через отдельный файл
### Добавлено
- Настройки плагина теперь хранятся в файле `.obsidian/plugins/literary-templates/settings.json` вместо стандартных методов loadData/saveData.
- Добавлена команда "Открыть настройки Literary Templates" для ручного редактирования файла настроек через Obsidian.

### Изменено
- Все обращения к настройкам переведены на работу с отдельным JSON-файлом.

### Исправлено
- Исключены ошибки ранней инициализации, связанные с this.app.vault при загрузке плагина.

## [2024-07-20] - Исправлен путь поиска промптов
### Изменено
- Путь поиска промптов теперь '.obsidian/plugins/literary-templates/templates/prompts' (относительно корня хранилища Obsidian).
- Промпты хранятся в папке плагина, а не в корне vault.
- Обновлена документация по использованию промптов.

## [2025-08-13] - Реализация PromptSelectorModal и парсера YAML-тегов
### Добавлено
- Новый модуль PromptSelectorModal.js на базе HtmlWizardModal: вертикальный список промптов, предпросмотр, копирование.
- Функция парсинга YAML-тегов (output, source, title, description) из промптов для отображения в модале.

### Изменено
- 

### Исправлено
- 

## [2025-08-13] - Удаление избыточной диагностики и ускорение загрузки
### Изменено
- Удалены или закомментированы все вызовы window.logDebug, plugin.logDebug, console.log, console.warn, console.error, не влияющие на критические ошибки, в main.bundle.js и связанных модулях.
- Исключены избыточные Notice, оставлены только сообщения об ошибках для пользователя.

### Добавлено
- 

### Исправлено
- 

## [2025-08-21] - Удаление избыточной диагностики из инициализации
### Изменено
- Полностью удалена избыточная диагностика (console.log, logDebug, console.warn, console.error) из инициализации, onload и AI сервисов. Оставлены только Notice для ошибок пользователя.

## [2025-08-21] - Универсальный промпт для расширения сущностей
### Добавлено
- Промпт `templates/prompts/refine-entity.md`: универсальная инструкция для НС по превращению любой сущности из заметки в полноценную статью (Markdown), с соблюдением фактов и структурой разделов.

### Изменено
- PromptSelector использует новый промпт из стандартной папки промптов.

### Исправлено
- Устранены ошибки обращения к `projectRoot` в ряде creators за счет унификации сигнатур (`startPath`).
