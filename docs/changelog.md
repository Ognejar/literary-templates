## [2025-09-09] - Внедрение агента документации и шаблонов

### Добавлено
- Документ `docs/documentation-agent.md` с назначением, триггерами и алгоритмом.
- Шаблоны для авто‑записей: `docs/_templates/changelog_entry.md`, `tasktracker_entry.md`, `functional_card_update.md`.

### Изменено
- Обновлён `docs/project.md`: добавлен раздел об агенте документации и его месте в архитектуре.

### Исправлено
- —

## [2025-01-27] - Исправление мастера создания локации (финальная версия)

### Изменено
- **LocationWizardModal.js** - исправлен мастер создания локации:
  - **Климат** - выпадающий список из настроек мира с fallback климатами (как в других мастерах)
  - **Тип локации** - произвольное текстовое поле вместо выпадающего списка
  - **Государство** - запрашивается на 4-м шаге (опционально) из папки Локации/Государства с чтением поля name
  - **Провинция** - запрашивается на 5-м шаге (опционально) с фильтрацией по выбранному государству
  - Увеличено количество шагов с 5 до 6
  - Добавлена загрузка климатов из настроек мира с fallback списком
  - Добавлена загрузка государств из папки Локации/Государства с чтением поля name из YAML
  - Добавлена загрузка провинций из папки Локации/Провинции с чтением поля state
  - **Все поля опциональны** (кроме названия) - убрана валидация для обязательных полей
  - Добавлена правильная логика фильтрации провинций по выбранному государству

### Исправлено
- **Новая_локация.md** - обновлен шаблон:
  - Возвращено поле `climate` в YAML
  - Добавлено поле `state` в YAML
  - Добавлены теги `локация` и `активный`
  - Обновлена структура шаблона с отображением климата и государства

### Изменено
- **EntityFactory.js** - обновлен метод `prepareLocationData`:
  - Добавлена поддержка поля `climate`
  - Добавлена поддержка всех полей локации (type, climate, province, state, status, description)

## [2025-01-27] - Обработка оставшихся шаблонов локаций

### Исправлено
- Убраны поля `history:` и `population_history:` из YAML в шаблонах:
  - `Новая_деревня.md` - заменены на статические секции "Хронология" и "Динамика населения"
  - `Новая_локация.md` - заменено на статическую секцию "Хронология"
  - `Новый_персонаж.md` - заменено на статическую секцию "Хронология"
  - `Новый_порт.md` - заменено на статическую секцию "Хронология"
  - `Новый_артефакт.md` - заменено на статическую секцию "Хронология"

### Удалено
- `templates/Новая_фракция.md` - от фракций отказались
- `templates/Новая_фортификация.md` - дублировал `Новый_замок.md`

### Изменено
- Все шаблоны локаций теперь используют единообразный формат хронологии: `- год:событие`
- Убраны Handlebars-циклы `{{#each history}}` из шаблонов

## [2025-01-27] - Рефакторинг main.js - применение принципов DRY, KISS, SRP

### Изменено
- Убрано дублирование функции `getStartPath` (было 3 копии)
- Добавлены вспомогательные методы:
  - `getCurrentStartPath()` - получает startPath из активного файла
  - `getCurrentProjectRoot()` - получает корень проекта из активного файла
  - `createEntityCallback()` - создает callback для команд создания сущностей
- Все команды создания сущностей (22 команды) теперь используют `createEntityCallback()`
- Упрощены команды `add-project-tasks-block` и `add-project-overview-block`
- Код стал более читаемым и поддерживаемым

## [2025-01-27] - Исправление логики выбора проекта в мастерах

### Исправлено
- Исправлена логика определения проекта в `EntityFactory.js` - добавлена проверка валидности текущего проекта
- Исправлено определение `startPath` во всех командах создания сущностей - теперь определяется динамически при вызове
- Исправлена функция `isProjectFolder` - теперь правильно определяет папки проектов по наличию подпапок с файлом "Настройки_мира.md"
- Убраны отладочные сообщения из `createMine.js` и `EntityFactory.js`

### Изменено
- Все команды создания сущностей теперь правильно определяют контекст проекта при вызове
- Логика выбора проекта работает корректно: если `startPath` в проекте - используется проект, если нет - проверяется текущий проект, если нет - показывается выбор

## [2025-01-27] - Рефакторинг инфраструктурных объектов (фермы, шахты, заводы)

### Исправлено
- Исправлены теги в шаблонах `Новая_ферма.md`, `Новая_шахта.md`, `Новый_завод.md` - добавлены теги "локация" и "активный"
- Убраны поля `history` из YAML в шаблонах инфраструктурных объектов, заменены на статические секции
- Исправлен формат тегов с массива на список в YAML
- Обновлены мастера `FarmWizardModal.js`, `MineWizardModal.js`, `FactoryWizardModal.js` - заменены выпадающие списки фракций на свободный ввод текста
- Убрана загрузка и валидация фракций из конфигурации в мастерах

### Добавлено
- Созданы индексные файлы `templates/Фермы.md`, `templates/Шахты.md`, `templates/Заводы.md` с Dataview-запросами
- Добавлены кнопки создания инфраструктурных объектов в `templates/Локации.md`
- Добавлены Dataview-запросы для ферм, шахт и заводов в `templates/Локации.md`

### Изменено
- Улучшен индексный файл `Локации.md` - теперь показывает все локации проекта с группировкой по типам
- Dataview запросы теперь корректно фильтруют сущности по папкам проекта
- Созданы шаблоны для индексных файлов: `templates/Локации.md`, `templates/Персонажи.md`, `templates/Сюжетные_линии.md`, `templates/Замки.md`
- Обновлен `createWorld.js` для использования шаблонов вместо хардкода
- Добавлена возможность кастомизации индексных файлов и добавления картинок

### Изменено
- Улучшен индексный файл `Локации.md` - теперь показывает все локации проекта с группировкой по типам
- Dataview запросы теперь корректно фильтруют сущности по папкам проекта
- Созданы шаблоны для индексных файлов: `templates/Локации.md`, `templates/Персонажи.md`, `templates/Сюжетные_линии.md`
- Обновлен `createWorld.js` для использования шаблонов вместо хардкода
- Добавлена возможность кастомизации индексных файлов и добавления картинок

## [2024-12-19] - Исправление синтаксических ошибок и завершение настройки автора

### Исправлено
- Исправлены все синтаксические ошибки `catch {}` на `catch (e) {}` во всех файлах проекта
- Добавлен файл `PluginSettingsModal.js` в список файлов для сборки в `build.php`
- Устранена ошибка `SyntaxError: Unexpected token 'catch'` при загрузке плагина
- Удалены все `await this.logDebug` и `await plugin.logDebug` из `catch` блоков для совместимости с JavaScript движком Obsidian
- Исправлены структурные ошибки в `try-catch` блоках в `main.js` (лишние скобки, неправильная структура)

### Изменено
- Удален шаг "Хронология" из мастера создания государства `StateWizardModal.js`
- Убраны поля `history_events` и `population_history` из данных мастера
- Удален метод `renderChronology` и соответствующая валидация
- Обновлена нумерация шагов в мастере (теперь 9 шагов вместо 10)
- Удалены шаги "История" и "История населения" из мастера создания провинции `ProvinceWizardModal.js`
- Убраны поля `history` и `populationHistory` из данных мастера провинции
- Удалены методы `renderHistory` и `renderPopulationHistory`
- Обновлена нумерация шагов в мастере провинции (теперь 8 шагов вместо 10)
- Обновлен шаблон `Новая_провинция.md` - убраны поля `history` и `population_history` из YAML, добавлены статические секции для ручного ввода

## [2025-09-05] - Анализ файла creators/createWorld.js
### Добавлено
- Анализ использования шаблонов в файле creators/createWorld.js
- Сравнение с другими креейторами
### Изменено
- Исправлены логические ошибки в файле creators/createWorld.js
### Исправлено
- Ошибки исправлены

## [2025-09-06] - Добавлено поле "Автор" в настройки плагина
### Добавлено
- В настройки плагина добавлено поле `author` для автоподстановки автора при создании мира, страны и других сущностей.
- Обеспечена обратная совместимость: если поле отсутствует в старых настройках, используется пустая строка.

## [2025-09-06] - Автоматическая подстановка автора для мира и произведения
### Изменено
- Теперь автор из настроек плагина автоматически подставляется только при создании мира и произведения. В остальных мастерах поле автора не используется.

## [2025-09-06] - Упрощение шаблона государства
### Изменено
- Из шаблона государства удалены поля history и population_history из YAML.
- Секции "Хронология" и "Динамика населения" теперь представлены как обычный текст, автор сам решает, что туда вносить.

## [2024-07-09] - Рефакторинг шаблона и мастера города
### Изменено
- В шаблоне Новый_город.md убраны поля history и population_history из YAML, добавлены статические секции для хронологии и динамики населения.
- В мастере CityWizardModal.js удалён шаг 'Хронология', удалены поля history и population_history, методы renderHistory и соответствующая валидация.

## [2024-07-09] - Свободный ввод фракций для всех сущностей
### Изменено
- Во всех мастерах создания (деревня, замок, порт, монстр, народ, организация и др.) выпадающий список фракций заменён на текстовое поле для свободного ввода.
- Теперь пользователь может указать любую фракцию для каждой сущности без ограничений на глобальный справочник.

## [2024-07-09] - Руководство пользователя: создание сущностей
### Добавлено
- Главы руководства пользователя по созданию сущностей:
  - Создание государства (включая пояснение о столичном округе как провинции)
  - Создание провинции
  - Создание города
  - Создание деревни
  - Создание замка/фортификации
  - Создание порта
- Обновлён индексный файл руководства пользователя

## [2024-07-09] - Обновление документации
### Изменено
- Исправлен индексный файл руководства пользователя: убрано дублирование "Создание страны" и "Создание государства"
- Помечены планируемые разделы как "*в разработке*"
- Обновлена карточка функционала с актуальными функциями

## [2025-09-06] - Универсальный выбор проекта для всех мастеров
### Изменено
- Все мастера (создания города, шахты, фермы, завода, провинции, государства, замка и др.) теперь при вызове вне проекта автоматически запрашивают проект через ProjectSelectorModal.
- После выбора проект становится текущим для плагина.
- Исключена возможность работы мастера без валидного projectRoot.

## [2024-07-10] - Исправления мастера деревни и Dataview-запросов
### Исправлено
- VillageWizardModal.js: поле "фракция" теперь опционально, исправлена ошибка с this.data.date (используется локальная переменная date).
- templates/Локации.md: добавлена фильтрация по тегу для секций "Города" и "Деревни" в Dataview-запросах.

### Изменено
- Улучшена надёжность фильтрации городов и деревень в индексах.

## [2024-07-10] - Улучшение мастера деревни: фильтрация государств и валидация фракции
### Исправлено
- VillageWizardModal.js: теперь в список государств попадают только файлы с type: "Государство" или тегом "государство"; полностью убрана валидация фракции (поле всегда опционально).

## [2024-07-10] - Оптимизация EntityFactory.js
### Изменено
- Вместо длинного switch-case для вызова prepareXData теперь используется динамический вызов метода по имени (prepare${entityType}Data).
- Код стал компактнее, проще для расширения и поддержки.
