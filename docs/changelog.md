## [2025-09-13] - Стандартизация порядка кнопок навигации во всех мастерах

### Изменено
- Во всех мастерах (шахта, ферма, завод, замок, провинция, мёртвая зона и др.) навигация переведена на flex-контейнер с единым порядком кнопок:
  - "Назад" всегда слева
  - "Далее"/"Создать" всегда справа
  - Используется flex-контейнер с justify-content: space-between
- Улучшен UX: пользователь всегда ожидает кнопку продолжения справа, возврата — слева

## [2025-09-12] - Исправление тегов с пробелами и стандартизация UI мастеров

### Исправлено
- **Теги с пробелами**: исправлена проблема с тегами, содержащими пробелы - теперь все пробелы заменяются на подчеркивания
  - `EntityFactory.js`: добавлена замена пробелов на подчеркивания во всех `typeLower` переменных
  - `ArtifactWizardModal.js`: исправлена обработка `typeLower` для артефактов
  - `AlchemyRecipeWizardModal.js`: исправлена обработка `categoryLower` для рецептов
  - Все мастера с пользовательскими тегами: исправлены функции `list()` и `normalizeList()` для замены пробелов на подчеркивания
- **ArtifactWizardModal.js**: исправлено наследование - теперь наследуется от `EntityWizardBase` вместо `HtmlWizardModal`
- Устранена ошибка `this.createLoreAnalysisButton is not a function` при создании артефактов
- Добавлен импорт `EntityWizardBase` в `ArtifactWizardModal.js`
- **Стандартизация кнопок**: исправлены названия кнопок завершения во всех мастерах:
  - `ArtifactWizardModal`: "✓ Создать артефакт" (было "✓ Готово")
  - `PeopleWizardModal`: "✓ Создать народ" (было "✓ Готово")
  - `SpellWizardModal`: "✓ Создать заклинание" (было "✓ Готово")
  - `ConflictWizardModal`: "✓ Создать конфликт" (было "✓ Создать")
  - `AlchemyRecipeWizardModal`: "✓ Создать рецепт" (было "✓ Готово")
  - `PotionWizardModal`: "✓ Создать зелье" (было "✓ Готово")
  - `HtmlWizardModal`: "✓ Готово" (было "Завершить")

## [2025-09-12] - Инлайн-создание сущностей из диалогов вставки
### Добавлено
- В диалоге вставки персонажа добавлен пункт «➕ Создать персонажа» с запуском мастера и последующей вставкой созданного персонажа.
- В диалоге вставки локации добавлен пункт «➕ Создать локацию» с запуском мастера и последующей вставкой созданной локации.
- В диалоге вставки сюжетной линии добавлены пункты «➕ Создать глобальную линию» и «➕ Создать локальную линию» (если определено произведение). Созданная линия автоматически дописывается в соответствующий `Сюжетные_линии.md` и тут же вставляется в сцену, а также записывается в фронтматтер `plot_lines_lines/plot_lines_degree/plot_lines_description`.

### Изменено
- Логика вставки сюжетной линии дополняет фронтматтер сцены тремя массивами вместо одного поля.

### Исправлено
- Повышена надёжность получения редактора при вставке из режима чтения: переключение в source и переинициализация редактора.
## [2025-09-11] - Добавлен шаблон локации

### Добавлено
- Шаблон `templates/Новая_локация.md` для мастера локаций (совместим с TemplateManager, поля: project, work, created, tags, characters, plot_lines; секции описания, контекста и связей; Dataview для связанных сцен).

### Изменено
- —

### Исправлено
- Ошибка генерации: «Шаблон Новая_локация не найден» при завершении мастера локации.

## [2025-09-11] - Поддержка Obsidian Bases (первый этап)

### Добавлено
- Документ `docs/bases.md` с рекомендациями по представлениям (Scenes, Chapters, Characters, Plotlines) и требованиями к свойствам фронтматтера.

### Изменено
- Шаблон `Новая_глава.md`: добавлено свойство `chapter_num` (оставлен `number` для совместимости). Таблицы Bases корректно показывают номер главы.

## [2025-09-11] - Проставление chapter_num при перенумерации

### Изменено
- `creators/structureTools.js (renumberChapters)`: при переименовании папок глав автоматически записывается `chapter_num` во фронтматтер главного файла папки.

## [2025-09-11] - TemplateManager: фикс путей шаблонов и глобальный хелпер

### Изменено
- `src/TemplateManager.js`: чтение шаблонов только из `.obsidian/plugins/literary-templates/templates`. Вернул глобальный хелпер `window.generateFromTemplate(...)` для обратной совместимости.

## [2025-09-11] - TemplateManager: диагностика отсутствующих шаблонов

### Добавлено
- Подробный лог при промахе: имя вольта, наличие папки `.obsidian/plugins/literary-templates/templates`, перечисление файлов в папке.

### Изменено
- `src/TemplateManager.js`: чтение/проверка шаблонов через файловый адаптер (`vault.adapter.read/exists/list`) для доступа к `.obsidian`.

## [2025-09-11] - Документация: правило доступа к шаблонам

### Добавлено
- В `docs/project.md` добавлен раздел «Правило: Чтение шаблонов из .obsidian».
- Создан `docs/documentation-agent.md` с закреплением правила и инструкцией.

## [2025-09-11] - Справочник: использование файлов из templates/Справочник

### Изменено
- `creators/createWorld.js`: при создании папки `Справочник` файлы берутся из `.obsidian/plugins/literary-templates/templates/Справочник/*.md` при наличии; иначе используется встроенная заготовка.

## [2025-09-11] - Главный файл проекта = имя папки (safeName)

### Исправлено
- `creators/createWorld.js`: главный файл создаётся как `<safeName>.md` (совпадает с именем папки). При наличии старого файла с пробелами контент переносится в новый, старый удаляется.

## [2025-09-11] - Sci‑Fi маршрутизация шаблонов по миру

### Добавлено
- `creators/EntityFactory.js`: выбор шаблонов `*_scifi.md`, если в `Настройки_мира.md` указано `worldType: scifi` или `setting: scifi`. При отсутствии sci‑fi шаблона используется обычный.
- Шаблоны: `templates/Новая_локация_scifi.md`, `templates/Новый_порт_scifi.md`, `templates/Новая_шахта_scifi.md`.

## [2025-09-11] - Упрощение мастера шахты

### Изменено
- `creators/MineWizardModal.js`: все поля кроме названия сделаны опциональными; удалена обязательность выбора государства/климата/описания/типов. Превью скрывает незаполненные поля. `TemplateManager.getRequiredFields` дополнен sci‑fi вариантами.

## [2025-09-12] - Поддержка include в шаблонах

### Добавлено
- `TemplateManager`: асинхронная обработка `{{include:...}}` до компиляции Handlebars. Поддержка путей вида `sections/Имя.md` и относительных от папки шаблонов. Улучшена обработка `{{#if key == value}}`.

### Исправлено
- —

## [2025-09-11] - Автонумерация сцен в главе

### Изменено
- `creators/createScene.js`: реализован автоинкремент `scene_num` по существующим файлам `Сцена_YY_*.md` в папке выбранной главы, с проверкой коллизий и форматом двух цифр.

### Исправлено
- Создание второй и последующих сцен больше не падает с сообщением «Файл уже существует: .../Сцена_01_...md». Новые сцены получают следующий свободный номер.

## [2025-09-11] - Удаление дубликата файла главы

### Исправлено
- `creators/createChapter.js`: устранён побочный эффект создания второго файла главы. Папка главы и индексный файл теперь используют одинаковый формат с дефисом: `Глава_NNN-Имя`. Дубликат с подчёркиванием больше не создаётся.
- `creators/structureTools.js`: генерация скелета и обнаружение глав обновлены для поддержки дефиса и обратной совместимости.

<<<<<<< Current (Your changes)
## [2025-09-09] - Модульный вынос из main.js и глобализация

### Добавлено
- Создан `src/FactsService.js`: `loadFacts`, `saveFacts`, `normalizeRussianFactKeys`, `collectReferencedIds`, `parseTypeAndNameFromId`, `addMissingEntityStubs`, `computeFactSignature`, `mergeFactsIntoProject`, `cleanJsonInput`.
- Создан `src/AIKeysManagerModal.js`: вынесен класс модального окна управления AI-ключами.
- Создан `src/PromptSelectorModal.js`: вынесен селектор промптов.
- Создан `src/FallbackAIProviderService.js`: резервный AI-провайдер.
- Создан `src/ProjectDiscovery.js`: `getAllProjectFolders`, `getAllProjectRoots`.
- Создан `src/FileUtils.js`: `safeCreateFile` (с глобализацией `window.safeCreateFile`).
- Создан `src/Globals.js`: централизованная глобализация `create*`-функций без переопределений.

### Изменено
- `build.php`: добавлены новые модули в правильном порядке сборки.
- `main.js`: подключение `FactsService`, удалены дублирующиеся локальные реализации; сохранена совместимость вызовов.

### Исправлено
- Исключены регрессии после удаления функций: все удалённые ранее функции восстановлены в отдельных модулях и подключены.

## [2025-09-09] - Очистка legacy-комментариев и подготовка к «Произведению»

### Добавлено
- Подготовлена задача на реализацию сущности «Произведение» (Work): структура, шаблон, команды и мастер.
- Добавлен шаблон `templates/Новое_произведение.md` для быстрого мастера создания произведения.
- Пункт «Создать произведение» добавлен в контекстное меню (раздел «📚 Сюжет и главы»).

### Изменено
- `main.js`: удалены и сжаты комментарии, ссылавшиеся на вынесенный код (AI, меню), чтобы уменьшить размер файла и шум.
- `main.js`: все AI-команды переведены на делегирование в `AIService`; оставлены только тонкие обёртки.

### Исправлено
- Устранено предупреждение «Unreachable code detected» в `testAIConnection()` путём удаления недостижимого блока кода после `return`.
=======
## [2025-09-09] - Внедрение агента документации и шаблонов

### Добавлено
- Документ `docs/documentation-agent.md` с назначением, триггерами и алгоритмом.
- Шаблоны для авто‑записей: `docs/_templates/changelog_entry.md`, `tasktracker_entry.md`, `functional_card_update.md`.

### Изменено
- Обновлён `docs/project.md`: добавлен раздел об агенте документации и его месте в архитектуре.

### Исправлено
- —
>>>>>>> Incoming (Background Agent changes)

## [2025-09-10] - Алиас команды для вставки сюжетной линии

### Добавлено
- Зарегистрирована команда `insert-plotline` с названием «Вставить сюжетную линию», вызывающая тот же колбэк, что и «Вставить сюжетную линию в сцену». Обеспечивает работу кнопок с обеими формулировками.

### Изменено
- Не требуется. Логика вставки сюжетной линии не менялась.

### Исправлено
- Кнопка «Literary Templates: Вставить сюжетную линию» теперь корректно работает благодаря регистрации команды-алиаса.

## [2025-01-27] - Исправление мастера создания локации (финальная версия)

### Изменено
- **LocationWizardModal.js** - исправлен мастер создания локации:
  - **Климат** - выпадающий список из настроек мира с fallback климатами (как в других мастерах)
  - **Тип локации** - произвольное текстовое поле вместо выпадающего списка
  - **Государство** - запрашивается на 4-м шаге (опционально) из папки Локации/Государства с чтением поля name
  - **Провинция** - запрашивается на 5-м шаге (опционально) с фильтрацией по выбранному государству
  - Увеличено количество шагов с 5 до 6
  - Добавлена загрузка климатов из настроек мира с fallback списком
  - Добавлена загрузка государств из папки Локации/Государства с чтением поля name из YAML
  - Добавлена загрузка провинций из папки Локации/Провинции с чтением поля state
  - **Все поля опциональны** (кроме названия) - убрана валидация для обязательных полей
  - Добавлена правильная логика фильтрации провинций по выбранному государству

### Исправлено
- **Новая_локация.md** - обновлен шаблон:
  - Возвращено поле `climate` в YAML
  - Добавлено поле `state` в YAML
  - Добавлены теги `локация` и `активный`
  - Обновлена структура шаблона с отображением климата и государства

### Изменено
- **EntityFactory.js** - обновлен метод `prepareLocationData`:
  - Добавлена поддержка поля `climate`
  - Добавлена поддержка всех полей локации (type, climate, province, state, status, description)

## [2025-01-27] - Обработка оставшихся шаблонов локаций

### Исправлено
- Убраны поля `history:` и `population_history:` из YAML в шаблонах:
  - `Новая_деревня.md` - заменены на статические секции "Хронология" и "Динамика населения"
  - `Новая_локация.md` - заменено на статическую секцию "Хронология"
  - `Новый_персонаж.md` - заменено на статическую секцию "Хронология"
  - `Новый_порт.md` - заменено на статическую секцию "Хронология"
  - `Новый_артефакт.md` - заменено на статическую секцию "Хронология"

### Удалено
- `templates/Новая_фракция.md` - от фракций отказались
- `templates/Новая_фортификация.md` - дублировал `Новый_замок.md`

### Изменено
- Все шаблоны локаций теперь используют единообразный формат хронологии: `- год:событие`
- Убраны Handlebars-циклы `{{#each history}}` из шаблонов

## [2025-01-27] - Рефакторинг main.js - применение принципов DRY, KISS, SRP

### Изменено
- Убрано дублирование функции `getStartPath` (было 3 копии)
- Добавлены вспомогательные методы:
  - `getCurrentStartPath()` - получает startPath из активного файла
  - `getCurrentProjectRoot()` - получает корень проекта из активного файла
  - `createEntityCallback()` - создает callback для команд создания сущностей
- Все команды создания сущностей (22 команды) теперь используют `createEntityCallback()`
- Упрощены команды `add-project-tasks-block` и `add-project-overview-block`
- Код стал более читаемым и поддерживаемым

## [2025-01-27] - Исправление логики выбора проекта в мастерах

### Исправлено
- Исправлена логика определения проекта в `EntityFactory.js` - добавлена проверка валидности текущего проекта
- Исправлено определение `startPath` во всех командах создания сущностей - теперь определяется динамически при вызове
- Исправлена функция `isProjectFolder` - теперь правильно определяет папки проектов по наличию подпапок с файлом "Настройки_мира.md"
- Убраны отладочные сообщения из `createMine.js` и `EntityFactory.js`

### Изменено
- Все команды создания сущностей теперь правильно определяют контекст проекта при вызове
- Логика выбора проекта работает корректно: если `startPath` в проекте - используется проект, если нет - проверяется текущий проект, если нет - показывается выбор

## [2025-01-27] - Рефакторинг инфраструктурных объектов (фермы, шахты, заводы)

### Исправлено
- Исправлены теги в шаблонах `Новая_ферма.md`, `Новая_шахта.md`, `Новый_завод.md` - добавлены теги "локация" и "активный"
- Убраны поля `history` из YAML в шаблонах инфраструктурных объектов, заменены на статические секции
- Исправлен формат тегов с массива на список в YAML
- Обновлены мастера `FarmWizardModal.js`, `MineWizardModal.js`, `FactoryWizardModal.js` - заменены выпадающие списки фракций на свободный ввод текста
- Убрана загрузка и валидация фракций из конфигурации в мастерах

### Добавлено
- Созданы индексные файлы `templates/Фермы.md`, `templates/Шахты.md`, `templates/Заводы.md` с Dataview-запросами
- Добавлены кнопки создания инфраструктурных объектов в `templates/Локации.md`
- Добавлены Dataview-запросы для ферм, шахт и заводов в `templates/Локации.md`

### Изменено
- Улучшен индексный файл `Локации.md` - теперь показывает все локации проекта с группировкой по типам
- Dataview запросы теперь корректно фильтруют сущности по папкам проекта
- Созданы шаблоны для индексных файлов: `templates/Локации.md`, `templates/Персонажи.md`, `templates/Сюжетные_линии.md`, `templates/Замки.md`
- Обновлен `createWorld.js` для использования шаблонов вместо хардкода
- Добавлена возможность кастомизации индексных файлов и добавления картинок

### Изменено
- Улучшен индексный файл `Локации.md` - теперь показывает все локации проекта с группировкой по типам
- Dataview запросы теперь корректно фильтруют сущности по папкам проекта
- Созданы шаблоны для индексных файлов: `templates/Локации.md`, `templates/Персонажи.md`, `templates/Сюжетные_линии.md`
- Обновлен `createWorld.js` для использования шаблонов вместо хардкода
- Добавлена возможность кастомизации индексных файлов и добавления картинок

## [2024-12-19] - Исправление синтаксических ошибок и завершение настройки автора

### Исправлено
- Исправлены все синтаксические ошибки `catch {}` на `catch (e) {}` во всех файлах проекта
- Добавлен файл `PluginSettingsModal.js` в список файлов для сборки в `build.php`
- Устранена ошибка `SyntaxError: Unexpected token 'catch'` при загрузке плагина
- Удалены все `await this.logDebug` и `await plugin.logDebug` из `catch` блоков для совместимости с JavaScript движком Obsidian
- Исправлены структурные ошибки в `try-catch` блоках в `main.js` (лишние скобки, неправильная структура)

### Изменено
- Удален шаг "Хронология" из мастера создания государства `StateWizardModal.js`
- Убраны поля `history_events` и `population_history` из данных мастера
- Удален метод `renderChronology` и соответствующая валидация
- Обновлена нумерация шагов в мастере (теперь 9 шагов вместо 10)
- Удалены шаги "История" и "История населения" из мастера создания провинции `ProvinceWizardModal.js`
- Убраны поля `history` и `populationHistory` из данных мастера провинции
- Удалены методы `renderHistory` и `renderPopulationHistory`
- Обновлена нумерация шагов в мастере провинции (теперь 8 шагов вместо 10)
- Обновлен шаблон `Новая_провинция.md` - убраны поля `history` и `population_history` из YAML, добавлены статические секции для ручного ввода

## [2025-09-05] - Анализ файла creators/createWorld.js
### Добавлено
- Анализ использования шаблонов в файле creators/createWorld.js
- Сравнение с другими креейторами
### Изменено
- Исправлены логические ошибки в файле creators/createWorld.js
### Исправлено
- Ошибки исправлены

## [2025-09-06] - Добавлено поле "Автор" в настройки плагина
### Добавлено
- В настройки плагина добавлено поле `author` для автоподстановки автора при создании мира, страны и других сущностей.
- Обеспечена обратная совместимость: если поле отсутствует в старых настройках, используется пустая строка.

## [2025-09-06] - Автоматическая подстановка автора для мира и произведения
### Изменено
- Теперь автор из настроек плагина автоматически подставляется только при создании мира и произведения. В остальных мастерах поле автора не используется.

## [2025-09-06] - Упрощение шаблона государства
### Изменено
- Из шаблона государства удалены поля history и population_history из YAML.
- Секции "Хронология" и "Динамика населения" теперь представлены как обычный текст, автор сам решает, что туда вносить.

## [2024-07-09] - Рефакторинг шаблона и мастера города
### Изменено
- В шаблоне Новый_город.md убраны поля history и population_history из YAML, добавлены статические секции для хронологии и динамики населения.
- В мастере CityWizardModal.js удалён шаг 'Хронология', удалены поля history и population_history, методы renderHistory и соответствующая валидация.

## [2024-07-09] - Свободный ввод фракций для всех сущностей
### Изменено
- Во всех мастерах создания (деревня, замок, порт, монстр, народ, организация и др.) выпадающий список фракций заменён на текстовое поле для свободного ввода.
- Теперь пользователь может указать любую фракцию для каждой сущности без ограничений на глобальный справочник.

## [2024-07-09] - Руководство пользователя: создание сущностей
### Добавлено
- Главы руководства пользователя по созданию сущностей:
  - Создание государства (включая пояснение о столичном округе как провинции)
  - Создание провинции
  - Создание города
  - Создание деревни
  - Создание замка/фортификации
  - Создание порта
- Обновлён индексный файл руководства пользователя

## [2024-07-09] - Обновление документации
### Изменено
- Исправлен индексный файл руководства пользователя: убрано дублирование "Создание страны" и "Создание государства"
- Помечены планируемые разделы как "*в разработке*"
- Обновлена карточка функционала с актуальными функциями

## [2025-09-06] - Универсальный выбор проекта для всех мастеров
### Изменено
- Все мастера (создания города, шахты, фермы, завода, провинции, государства, замка и др.) теперь при вызове вне проекта автоматически запрашивают проект через ProjectSelectorModal.
- После выбора проект становится текущим для плагина.
- Исключена возможность работы мастера без валидного projectRoot.

## [2024-07-10] - Исправления мастера деревни и Dataview-запросов
### Исправлено
- VillageWizardModal.js: поле "фракция" теперь опционально, исправлена ошибка с this.data.date (используется локальная переменная date).
- templates/Локации.md: добавлена фильтрация по тегу для секций "Города" и "Деревни" в Dataview-запросах.

### Изменено
- Улучшена надёжность фильтрации городов и деревень в индексах.

## [2024-07-10] - Улучшение мастера деревни: фильтрация государств и валидация фракции
### Исправлено
- VillageWizardModal.js: теперь в список государств попадают только файлы с type: "Государство" или тегом "государство"; полностью убрана валидация фракции (поле всегда опционально).

## [2024-07-10] - Оптимизация EntityFactory.js
### Изменено
- Вместо длинного switch-case для вызова prepareXData теперь используется динамический вызов метода по имени (prepare${entityType}Data).
- Код стал компактнее, проще для расширения и поддержки.
