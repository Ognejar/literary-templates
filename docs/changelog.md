# Журнал изменений

## [2025-08-13] - Сборщик: копирование шаблонов и диагностика
### Добавлено
- Рекурсивное копирование папок `templates` и `templates/sections` в целевую папку плагина при сборке.
- Диагностические сообщения: размер `main.bundle.js`, сравнение с суммарным размером исходников, упрощённый отчёт по дублирующимся сигнатурам.

## [2025-08-13] - Артефакт: фиксы Notice и унификация кнопок
### Изменено
- `ArtifactWizardModal.js`: финальная кнопка переименована на `✓ Готово` для единообразия с другими мастерами.
- `creators/createArtifact.js`: передача классов `Modal/Setting/Notice` из общего импорта Obsidian вместо `plugin.*`.

### Исправлено
- Ошибка `TypeError: this.Notice is not a constructor` при завершении мастера артефакта.

### Изменено
- `build.php`: возвращена логика из `oldbuild.php` для копирования шаблонов; добавлена функция `copyDir`, дополнительные проверки и логи.

### Исправлено
- Проблема, из-за которой шаблоны не обновлялись в папке плагина при сборке.

## [2025-08-13] - Артефакт: создание общих секций и обновление шаблона
### Добавлено
- Создана общая секция `Шапка.md` для всех документов (изображение + заголовок).
- Созданы общие секции в `templates/sections/`: Магические_свойства, Ограничения_и_риски, Особенности, Способ_создания, Обслуживание, Владение_и_расположение.
- Каждая секция содержит условные блоки `{{#if}}` для отображения только при наличии данных.

### Изменено
- Обновлен шаблон `Новый_артефакт.md`: заменены include-секции на общие секции через `{{include:sections/...}}`.
- Убрана дублирующая папка `Артефакт/` - теперь все секции общие для всех типов документов.
- Шапка документа теперь выносится в отдельную секцию `{{include:sections/Шапка.md}}`.

### Исправлено
- Устранено дублирование кода секций между разными типами сущностей.
- Исправлена целевая папка в `build.php`: изменена с `obsidian-mini-templater` на `literary-templates`.

## [2025-08-13] - Тонущий мир: изображения и очистка служебных маркеров
### Добавлено
- Опциональные блоки изображений для карточек городов (`![[Теговые_картинки/Город.webp]]`) и провинций (`![[Теговые_картинки/Провинция.webp]]`).

### Исправлено
- Удалены служебные маркеры `tp.file.cursor()` из всех `.md` файлов проекта.

## [2025-08-12] - Сборка: актуальный бандл и фиксы алхимии
### Изменено
- `build.php`: добавлен `AlchemyRecipeWizardModal.js` и `creators/createAlchemyRecipe.js` в список исходников; добавлен `chdir(__DIR__)` для корректного запуска из любой директории.
- `AlchemyRecipeWizardModal.js`: переход на генерацию по шаблону через `generateFromTemplate`; нормализация manual-значений; автоподбор `tagImage` (по первому тегу или `Алхимия.*`); автопополнение справочников (категории/эффекты/теги алхимии) без дублей с сортировкой; унификация UI — убраны дублирующие текстовые поля «Ингредиенты» и «Эффекты», финальная кнопка «✓ Готово».
- `creators/createAlchemyRecipe.js`: передача `plugin` в модальное окно; выравнивание аргументов конструктора.

### Исправлено
- ReferenceError при onload: актуальная логика доступности `window.createAlchemyRecipe` теперь попадает в активный `main.bundle.js` и копируется в папку плагина.

## [2025-08-12] - Тонущий мир: нормализация структуры локаций
### Изменено
- Перенесены города в `Локации/Города/`: `Любенбург.md`, `Велюмарк.md`, `Рюэн.md`, `Барраир.md`.
- Перенесена провинция `Велюградия.md` в `Провинции/`.

### Исправлено
- Удалён пустой дубликат государства `Локации/Гарданский Союз.md` (основной файл — `Государства/Гарданский_Союз.md`).

## [2025-08-12] - Исправление предупреждений ESLint
### Изменено
- Обновлена обработка исключений с использованием optional catch binding в местах, где переменная ошибки не используется.

### Исправлено
- В `main.js` на строке с `catch (_){}` заменено на `catch {}` в методе `getActiveEditor()`.
- В `main.js` в методе `processSingleInclude()` заменено `catch (fsError){}` на `catch {}` для устранения предупреждения о неиспользуемой переменной.

## [2025-08-12] - Автодобавление ингредиентов в справочник
### Добавлено
- В мастер создания зелий добавлен переключатель «Добавлять новые ингредиенты в справочник» (по умолчанию включен).
- Автоматическая запись уникальных ингредиентов в `Магия/Справочники/Ингредиенты_зелий.md` при завершении мастера.

### Изменено
- Обновлен `PotionWizardModal.js` (шаг «Ингредиенты») и DocBlock `@updated`.
- Обновлен `createPotion.js`: логика чтения/слияния и сортировки списка ингредиентов.
 
### Исправлено
- В выводе зелий больше не попадает слово `manual` — для ингредиентов/эффектов/тегов/локаций при выборе «Ввести вручную» берётся текст из соответствующих полей.

## [2025-08-12] - Поддержка справочников для зелий и правка сложности
### Добавлено
- Поддержка справочников: `Сложности_зелий.md`, `Время_приготовления_зелий.md` в мастере зелий.
- Возможность выбирать из справочника или вводить вручную (для времени и сложности).
 - Новый справочник инструментов: `Инструменты_зельеварения.md`. Динамический список инструментов в мастере с добавлением по кнопке.

### Изменено
- Обновлен `PotionWizardModal.js` (шаг «Процесс приготовления») — выпадающие списки для времени и сложности.
- Обновлен `createPotion.js` — корректная подстановка при выборе «ручной ввод».

### Исправлено
- Уточнены формулировки сложности в женском роде: «Легкая», «Средняя», «Высокая», «Экспертная», «Мастерская».

## [2024-12-19] - Завершение системы магических функций
### Добавлено
- Создан модальный мастер для артефактов (`ArtifactWizardModal.js`)
- Создан модальный мастер для алхимических рецептов (`AlchemyRecipeWizardModal.js`)
- Добавлена функция создания артефактов (`createArtifact.js`)
- Добавлена функция создания алхимических рецептов (`createAlchemyRecipe.js`)
- Обновлен шаблон артефактов с поддержкой новых полей
- Создан новый шаблон алхимических рецептов
- Включены алхимические рецепты в контекстное меню

### Изменено
- Заменена старая функция `createArtifact` в main.js на новую модульную версию
- Обновлено меню "Магия" - все функции теперь активны

### Исправлено
- Удалена дублированная функция `createArtifact` из main.js

## [2024-12-19] - Завершение системы статусов для всех локаций
### Добавлено
- Система статусов (действует/заброшено/разрушено) для всех типов локаций
- Условное отображение производственных/экономических секций в зависимости от статуса
- Шаги статуса во всех модальных окнах создания локаций
- Поле "Причина" для заброшенных и разрушенных локаций

### Изменено
- Обновлены все шаблоны локаций для поддержки статусов
- Модифицированы все модальные окна для включения шага статуса
- Обновлены функции создания для передачи данных о статусе

### Исправлено
- Условные операторы в шаблонах теперь работают корректно
- Удалены дублированные включения секций
- Исправлены вложенные условные блоки

## [2024-12-19] - Реструктуризация контекстного меню
### Добавлено
- Иерархическая структура меню с подменю
- Группировка команд по категориям
- Разделители между разделами

### Изменено
- Перемещены основные разделы в начало меню
- Перемещены служебные функции в конец
- Улучшена навигация и логика меню

## [2024-12-19] - Команды вставки контента
### Добавлено
- Команда "Вставить TODO" для создания задач в текущем файле
- Команда "Вставить сюжетную линию в сцену" для вставки сюжетных линий
- Парсинг файла Сюжетные_линии.md
- Автоматическое определение типа сущности

### Изменено
- Улучшена функция `getActiveEditor` для безопасной работы с MarkdownView
- Добавлена поддержка различных форматов TODO

## [2024-12-19] - Dataview отчеты в главный файл проекта
### Добавлено
- Отчет "Локации по статусам"
- Отчет "Невыполненные задачи"
- Отчет "Пустые карточки"
- Отчет "Города и провинции"

### Изменено
- Главный файл проекта теперь содержит полезные отчеты для отслеживания прогресса

## [2024-12-19] - Исправление ошибок шаблонов
### Исправлено
- Обработка условных операторов {{#if status == действует}}
- Удаление дублированных включений {{include:sections/История.md}}
- Исправление вложенных условных блоков
- Улучшение обработки include-блоков
- Замена {{else if}} на независимые {{#if}} блоки

## [2024-12-19] - Планирование оптимизации системы шаблонов
### Добавлено
- Анализ текущей системы шаблонов
- Определение повторяющихся секций
- План перехода к include-блокам
- План унификации шаблонов

### Изменено
- Документирован план оптимизации системы шаблонов

## [2024-12-19] - Улучшение интерфейса алхимических рецептов

### Добавлено
- Динамический интерфейс для ввода ингредиентов с возможностью добавления/удаления
- Кнопка "+ Добавить ингредиент" для создания произвольного количества ингредиентов
- Кнопки удаления для каждого ингредиента (кроме последнего)
- Улучшенная валидация с проверкой наличия хотя бы одного ингредиента

### Изменено
- Переработан метод `renderIngredients()` в `AlchemyRecipeWizardModal.js`
- Добавлены методы `renderIngredientsList()` и `updateIngredientsData()`
- Обновлен метод `createRecipe()` для работы с новым форматом ингредиентов
- Улучшена валидация шага ингредиентов

### Исправлено
- Проблема с невозможностью ввода ингредиентов вручную
- Отсутствие справочника ингредиентов больше не является препятствием

## [2025-08-13] - Персонажи и заклинания на HtmlWizardModal; секции и шапка
### Добавлено
- Базовый класс `HtmlWizardModal` теперь используется в `CharacterWizardModal` и `SpellWizardModal` (унификация UI и кнопок)
- Общие секции для персонажей: `Шапка.md`, `Основная_информация.md`, `Описание.md`, `Особенности.md`, `Автоматические_связи.md`

### Изменено
- `Новый_персонаж.md` переведён на include секции и генерацию через `generateFromTemplate`
- В меню активирован пункт «Создать персонажа»
- `CharacterWizardModal` показывает изображение из `Теговые_картинки` с фолбэком: `Персонаж` → `character` → по расе
- `SpellWizardModal` переведён на `HtmlWizardModal` (прогресс-бар, кнопки, стили)

### Исправлено
- Отображение тэгового изображения в шапке через условный блок в `sections/Шапка.md`
