# Система многопроизведенческого мира

## Проблема
Как писать несколько произведений в одном мире, если они происходят в разные временные периоды?

## Решение: Система эпох и временных контекстов

### 1. Структура проекта

```
Мир/
├── 1_Рукопись/
│   ├── Произведения/
│   │   ├── Рассказ_1313/
│   │   │   ├── Главы/
│   │   │   ├── Сцены/
│   │   │   └── Персонажи/
│   │   └── Роман_1487/
│   │       ├── Главы/
│   │       ├── Сцены/
│   │       └── Персонажи/
│   └── Общие_элементы/
│       ├── Сюжетные_линии/
│       └── Задачи/
├── Локации/
│   ├── Государства/
│   ├── Провинции/
│   └── Города/
├── Персонажи/
├── Фракции/
└── .lore/
    ├── timeline.json
    ├── epochs.json
    └── temporal_contexts.json
```

### 2. Система эпох

#### Файл `.lore/epochs.json`
```json
{
  "epochs": [
    {
      "id": "early_medieval",
      "name": "Раннее Средневековье",
      "startYear": 1000,
      "endYear": 1300,
      "description": "Период становления королевств",
      "active": false
    },
    {
      "id": "late_medieval",
      "name": "Позднее Средневековье", 
      "startYear": 1300,
      "endYear": 1500,
      "description": "Расцвет торговли и ремесел",
      "active": true
    }
  ]
}
```

#### Файл `.lore/temporal_contexts.json`
```json
{
  "contexts": [
    {
      "id": "story_1313",
      "name": "Рассказ 1313 года",
      "epochId": "early_medieval",
      "year": 1313,
      "description": "История о рыцаре и драконе",
      "active": false
    },
    {
      "id": "novel_1487", 
      "name": "Роман 1487 года",
      "epochId": "late_medieval",
      "year": 1487,
      "description": "История о торговце и интригах",
      "active": true
    }
  ]
}
```

### 3. Версионирование сущностей

Каждая сущность (город, персонаж, фракция) может иметь несколько версий:

#### Пример: Город Велюмарк
```yaml
---
name: Велюмарк
state: Гардарский_Союз
province: Велюградия
founded: 1205
temporal_versions:
  - epoch: early_medieval
    year: 1313
    population: 5000
    description: Небольшой торговый город
    features: [торговая_площадь, крепостные_стены]
  - epoch: late_medieval  
    year: 1487
    population: 15000
    description: Крупный торговый центр
    features: [торговая_площадь, крепостные_стены, университет, порт]
---
```

### 4. Команды плагина

#### Новые команды:
- **"Создать эпоху"** - создание новой временной эпохи
- **"Создать временный контекст"** - создание контекста для произведения
- **"Переключить эпоху"** - переключение между эпохами
- **"Показать изменения"** - показать как изменилась сущность между эпохами
- **"Создать произведение"** - создание нового произведения в определенной эпохе

### 5. UI компоненты

#### EpochSelectorModal
- Выбор активной эпохи
- Просмотр всех эпох
- Создание новой эпохи

#### TemporalContextModal  
- Управление временными контекстами
- Связывание произведений с эпохами
- Переключение между контекстами

#### EntityVersionViewer
- Просмотр всех версий сущности
- Сравнение версий
- Создание новой версии

### 6. Логика работы

#### При создании сущности:
1. Определяется активная эпоха
2. Создается версия для этой эпохи
3. Добавляется в temporal_versions

#### При переключении эпохи:
1. Все визарды показывают данные для выбранной эпохи
2. Шаблоны используют актуальные данные
3. Ссылки указывают на правильные версии

#### При создании произведения:
1. Создается временный контекст
2. Создается папка произведения
3. Настраивается фильтрация по эпохе

### 7. Шаблоны

#### Шаблон произведения
```yaml
---
title: "{{title}}"
type: произведение
epoch: "{{epoch}}"
year: {{year}}
context: "{{context}}"
---
```

#### Шаблон главы
```yaml
---
title: "{{title}}"
work: "{{work}}"
epoch: "{{epoch}}"
year: {{year}}
chapter: {{chapter}}
---
```

### 8. Dataview запросы

#### Все города в эпохе
```dataview
TABLE name, state, population
FROM "Локации/Города"
WHERE epoch = "{{active_epoch}}"
```

#### Все персонажи произведения
```dataview
TABLE name, role, location
FROM "Персонажи"
WHERE work = "{{current_work}}"
```

### 9. Преимущества системы

1. **Изоляция произведений** - каждое произведение работает в своем контексте
2. **Общий лор** - все произведения используют общую базу знаний
3. **Версионирование** - сущности могут развиваться во времени
4. **Гибкость** - можно легко переключаться между эпохами
5. **Консистентность** - система следит за логикой изменений

### 10. Реализация

#### Этап 1: Базовая структура
- Создание системы эпох
- Базовые команды
- Простые модальные окна

#### Этап 2: Версионирование
- Система версий сущностей
- UI для управления версиями
- Шаблоны с поддержкой эпох

#### Этап 3: Произведения
- Система временных контекстов
- Изоляция произведений
- Специализированные шаблоны

#### Этап 4: Продвинутые функции
- Сравнение версий
- Визуализация изменений
- Автоматические связи между эпохами
