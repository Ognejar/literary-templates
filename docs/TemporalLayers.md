# Система временных слоев (Temporal Layers)

## Обзор

Система временных слоев позволяет управлять лором литературного мира в разные исторические периоды. Каждый временной слой (эпоха) содержит изолированную версию лора, что позволяет создавать непротиворечивую историю без влияния будущих событий на прошлое.

## Компоненты системы

### 1. TimelineService

Управляет временными периодами (эпохами) мира.

#### Основные функции:
- Создание и управление эпохами
- Активация текущей эпохи
- Получение информации об эпохах

#### Методы:
- `createEpoch(epochData)` - Создание новой эпохи
- `getEpochById(id)` - Получение эпохи по ID
- `getAllEpochs()` - Получение всех эпох
- `setActiveEpoch(id)` - Установка активной эпохи
- `getActiveEpoch()` - Получение активной эпохи

### 2. TemporalEntityService

Работает с версионированными сущностями лора.

#### Основные функции:
- Сохранение сущностей в контексте активной эпохи
- Получение сущностей из определенной эпохи
- Управление версиями сущностей
- Механизм наследования свойств между версиями

#### Методы:
- `saveEntity(entity)` - Сохранение сущности в активной эпохе
- `getEntity(id, epochId)` - Получение сущности из определенной эпохи
- `getAllVersions(id)` - Получение всех версий сущности
- `getVersion(id, version)` - Получение конкретной версии сущности

### 3. TemporalContextService

Управляет временным контекстом и зависимостями между сущностями.

#### Основные функции:
- Отслеживание зависимостей между сущностями
- Проверка целостности временного контекста
- Обеспечение согласованности данных в рамках эпохи

#### Методы:
- `getContext()` - Получение текущего временного контекста
- `getEntityDependencies(entityId)` - Получение зависимостей сущности
- `checkContextIntegrity()` - Проверка целостности контекста
- `resolveDependencies(entity)` - Разрешение зависимостей сущности

### 4. MigrationService

Обеспечивает миграцию существующих проектов в систему временных слоев.

#### Основные функции:
- Миграция существующих данных в систему временных слоев
- Проверка совместимости данных
- Отчет о статусе миграции

#### Методы:
- `migrateProject(projectPath)` - Миграция проекта
- `validateMigration(projectPath)` - Проверка совместимости
- `getMigrationStatus(projectPath)` - Получение статуса миграции
- `rollbackMigration(projectPath)` - Откат миграции

### 5. TemporalAPI

Унифицированный API для доступа ко всем функциям системы временных слоев.

#### Основные функции:
- Централизованный доступ ко всем сервисам
- Упрощенный интерфейс для внешних компонентов

#### Методы:
- `getAllEpochs()` - Получение всех эпох
- `getEntity(id)` - Получение сущности из активной эпохи
- `getAllVersions(id)` - Получение всех версий сущности
- `getContext()` - Получение текущего контекста
- `createEpoch(epochData)` - Создание новой эпохи

## Использование системы

### Создание эпохи

```javascript
const epoch = temporalAPI.createEpoch({
    id: "medieval_era",
    name: "Средневековье",
    description: "Эпоха средневековья",
    startDate: "1000",
    endDate: "1500"
});
```

### Работа с сущностями

```javascript
// Сохранение сущности в активной эпохе
const character = {
    id: "character:king_arthur",
    type: "character",
    name: "Король Артур",
    attributes: {
        age: 40,
        title: "Король"
    }
};

temporalAPI.saveEntity(character);

// Получение сущности
const retrievedCharacter = temporalAPI.getEntity("character:king_arthur");
```

### Миграция существующего проекта

```javascript
// Проверка совместимости
const validation = migrationService.validateMigration("/path/to/project");

if (validation.compatible) {
    // Миграция проекта
    const result = migrationService.migrateProject("/path/to/project");
    
    if (result.success) {
        console.log("Проект успешно мигрирован");
    }
}
```

## Преимущества системы

1. **Изоляция временных периодов** - Каждая эпоха содержит независимую версию лора
2. **Версионирование сущностей** - Возможность отслеживать изменения сущностей во времени
3. **Механизм наследования** - Новые версии могут наследовать свойства от предыдущих
4. **Целостность данных** - Проверка зависимостей и согласованности в рамках эпохи
5. **Обратная совместимость** - Поддержка миграции существующих проектов

## Интеграция с существующими компонентами

Система временных слоев интегрирована с основным плагином через:
- Глобальные переменные для доступа к сервисам
- Команду управления эпохами в контекстном меню
- Модальное окно управления эпохами

## Тестирование

Для проверки функциональности системы создан тестовый сценарий [`test/temporal_test.js`](file:///h:/1_Plugun_work/test/temporal_test.js), который проверяет все основные компоненты системы.