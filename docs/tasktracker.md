## Задача: Инлайн-создание сущностей из диалогов вставки
- **Статус**: Завершена
- **Описание**: Добавить опции «➕ Создать …» в диалоги вставки персонажей, локаций и сюжетных линий; обеспечить немедленную вставку созданной сущности и обновление фронтматтера сцены.
- **Шаги выполнения**:
  - [x] Добавить пункт «➕ Создать персонажа» в диалог вставки персонажа
  - [x] Добавить пункт «➕ Создать локацию» в диалог вставки локации
  - [x] Добавить пункты «➕ Создать глобальную/локальную линию» в диалог вставки сюжетной линии
  - [x] Обновить фронтматтер сцены (plot_lines_lines/plot_lines_degree/plot_lines_description)
  - [x] Собрать и развернуть плагин
- **Зависимости**: Созданные ранее мастера создания сущностей; TemplateManager
## Задача: Справочник из пользовательских шаблонов
- **Статус**: Завершена
- **Описание**: При создании мира файлы папки `Справочник` берутся из `.obsidian/plugins/literary-templates/templates/Справочник` если существуют.
- **Шаги выполнения**:
  - [x] Обновить `creators/createWorld.js`
  - [x] Обновить changelog
- **Зависимости**: Наличие пользовательских файлов шаблонов

## Задача: Главный файл совпадает с именем папки
- **Статус**: Завершена
- **Описание**: Главный файл мира создаётся как `<safeName>.md`; дубликаты с пробелами мигрируются: контент переносится, старый файл удаляется.
- **Шаги выполнения**:
  - [x] Обновить `creators/createWorld.js`
  - [x] Обновить changelog
- **Зависимости**: Создание мира

## Задача: Маршрутизация sci‑fi шаблонов
- **Статус**: В процессе
- **Описание**: Если мир `scifi`, использовать `*_scifi.md` с fallback на обычные.
- **Шаги выполнения**:
  - [x] Обновить `creators/EntityFactory.js`
  - [x] Добавить sci‑fi шаблоны в templates (минимальный набор)
  - [ ] Проверить создание Локации/Порта/Шахты в sci‑fi проекте
- **Зависимости**: Наличие `worldType/setting` в `Настройки_мира.md`
## Задача: Диагностика отсутствующих шаблонов в TemplateManager
- **Статус**: Завершена
- **Описание**: Добавлена детальная диагностика при промахе поиска шаблона: имя вольта, проверка папки и список файлов.
- **Шаги выполнения**:
  - [x] Логировать имя текущего вольта
  - [x] Проверять наличие папки `.obsidian/plugins/literary-templates/templates`
  - [x] Выводить список файлов в папке шаблонов
- **Зависимости**: Использование шаблонов всеми визардами

## Задача: Упростить мастер «Шахта»
- **Статус**: Завершена
- **Описание**: Оставлено только обязательным поле названия; остальное опционально.
- **Шаги выполнения**:
  - [x] Ослабить валидацию шагов
  - [x] Сделать выпадающие поля опциональными
  - [x] Скрывать пустые поля в предпросмотре
- **Зависимости**: Шаблон `Новая_шахта`/`Новая_шахта_scifi`

## Задача: Добавить обработку include в шаблонах
- **Статус**: В процессе
- **Описание**: Реализовать поддержку `{{include:...}}` в TemplateManager с поиском в `.obsidian/plugins/literary-templates/templates`.
- **Шаги выполнения**:
  - [x] Реализовать _processIncludes
  - [x] Вставить обработку до Handlebars
  - [ ] Протестировать на `Новая_шахта.md`
- **Зависимости**: `src/TemplateManager.js`
## Задача: Доступ к шаблонам в .obsidian через файловый адаптер
- **Статус**: Завершена
- **Описание**: Использование `vault.adapter` для `exists/read/list` вместо `getAbstractFileByPath` при работе с `.obsidian`.
- **Шаги выполнения**:
  - [x] Обновить `readTemplateFile`
  - [x] Обновить `templateExists`
  - [x] Обновить `getAvailableTemplates`
- **Зависимости**: Все операции генерации по шаблонам

## Задача: Зафиксировать правило чтения шаблонов
- **Статус**: Завершена
- **Описание**: Добавлены разделы в документации с запретом менять механизм доступа и указанием на использование `vault.adapter`.
- **Шаги выполнения**:
  - [x] Обновить `docs/project.md`
  - [x] Добавить `docs/documentation-agent.md`
  - [x] Обновить `docs/changelog.md`
- **Зависимости**: Процессы разработки и поддержки плагина
## Задача: Фикс путей TemplateManager и возврат глобального хелпера
- **Статус**: Завершена
- **Описание**: Настроено чтение шаблонов только из `.obsidian/plugins/literary-templates/templates` и возвращён `window.generateFromTemplate` для совместимости.
- **Шаги выполнения**:
  - [x] Обновить `readTemplateFile` и пути в `templateExists`, `getAvailableTemplates`
  - [x] Вернуть глобальный хелпер `window.generateFromTemplate`
  - [x] Обновить changelog и трекер задач
- **Зависимости**: Использование шаблонов визардами создания сущностей
## Задача: Поддержка Obsidian Bases — представления
- **Статус**: В процессе
- **Описание**: Добавить табличные представления для сцен, глав, персонажей и сюжетных линий на базе свойств фронтматтера.
- **Шаги выполнения**:
  - [x] Подготовить документ `docs/bases.md`
  - [ ] Проверить поля в шаблонах (пустые массивы по умолчанию)
  - [ ] Создать представления в UI и зафиксировать инструкции
- **Зависимости**: Консистентность свойств во всех шаблонах

## Задача: Автонумерация сцен в главе
- **Статус**: Завершена
- **Описание**: Реализовать автоматический выбор следующего номера сцены (YY) при создании новой сцены в папке главы, избежать коллизий имён.
- **Шаги выполнения**:
  - [x] Просканировать существующие файлы `Сцена_YY_*.md`
  - [x] Вычислить `max(YY)+1`, паддинг до 2 цифр
  - [x] Луп проверки коллизий, инкремент до свободного имени
  - [x] Проставлять `scene_num` в данные шаблона
- **Зависимости**: `creators/createScene.js`

## Задача: Добавить шаблон локации
- **Статус**: Завершена
- **Описание**: Создать недостающий шаблон `templates/Новая_локация.md`, чтобы мастер локаций корректно завершал генерацию.
- **Шаги выполнения**:
  - [x] Создать файл шаблона
  - [x] Обновить changelog
  - [x] Обновить tasktracker
- **Зависимости**: TemplateManager читает только `.obsidian/plugins/literary-templates/templates/<name>.md`

## Задача: Вынести утилиты и классы из main.js в модули
- **Статус**: В процессе
- **Описание**: Перенос крупных фрагментов из main.js в отдельные модули с подключением в сборке и глобализацией только при необходимости.
- **Шаги выполнения**:
  - [x] Создать `src/FactsService.js` и подключить использования
  - [x] Создать `src/AIKeysManagerModal.js` и подключить
  - [x] Создать `src/PromptSelectorModal.js` и подключить
  - [x] Создать `src/FallbackAIProviderService.js` и подключить
  - [x] Создать `src/ProjectDiscovery.js` и подключить
  - [x] Создать `src/FileUtils.js` и подключить
  - [x] Создать `src/Globals.js` (глобализация create*)
  - [x] Проверить и убрать дубли в `main.js` только после верификации неиспользования
## Задача: Реализовать создание «Произведения» (Work)
- **Статус**: Не начата
- **Описание**: Добавить функционал создания произведения с шаблоном и инфраструктурой: команды, контекстное меню, опционально мастер (визард) с шагами (жанр, статус, аннотация, связь с главами), генерация структуры папок и файла.
- **Шаги выполнения**:
  - [ ] Определить структуру проекта для произведений (папка, индекс)
  - [ ] Подготовить шаблон `templates/Новое_произведение.md`
  - [ ] Добавить команду `create-work` и коллбэк с `createEntityCallback`
  - [ ] (Опционально) Создать `WorkWizardModal` и зарегистрировать
  - [ ] Интегрировать в контекстное меню через `MenuRegistry`
  - [ ] Обновить документацию и changelog
- **Зависимости**: TemplateManager, ProjectManager, MenuRegistry, SettingsManager
- **Зависимости**: Обновление `build.php`, проверка вызовов в `main.js` и creators/*
## Задача: Анализ файла creators/createWorld.js
- **Статус**: Завершена
- **Описание**: Анализ использования шаблонов в файле creators/createWorld.js и сравнение с другими креейторами.
- **Шаги выполнения**:
  - [x] Создать запись в changelog.md о текущем состоянии задачи
  - [x] Создать запись в tasktracker.md о текущем состоянии задачи
  - [x] Предоставить краткий отчет о достигнутом прогрессе и планах на следующую сессию
  - [x] Исправить логические ошибки в файле creators/createWorld.js
  - [x] Анализ использования шаблонов в файле creators/createWorld.js
  - [x] Сравнение с другими креейторами
- **Зависимости**: -

## Задача: Добавить поле "Автор" в настройки плагина
- **Статус**: Завершена
- **Описание**: Необходимо добавить поле author в структуру настроек плагина, методы загрузки/сохранения и обеспечить автоподстановку автора в мастерах создания сущностей.
- **Шаги выполнения**:
  - [x] Добавить поле author в структуру настроек и методы загрузки/сохранения
  - [x] Реализовать секцию "Автор" в окне настроек плагина
  - [x] Обеспечить автоподстановку автора в мастерах (только для мира и произведения)
  - [ ] Обновить документацию
- **Зависимости**: Нет

## Задача: Настройка агента документации
- **Статус**: В процессе
- **Описание**: Внедрить преднастроенного агента для авто‑обновления `docs/changelog.md`, `docs/tasktracker.md`, актуализации `docs/project.md` и карточек функционала на базе диффов изменённых модулей.
- **Шаги выполнения**:
  - [x] Создать спецификацию агента (`docs/documentation-agent.md`)
  - [x] Добавить шаблоны в `docs/_templates` (changelog/tasktracker/functional card)
  - [x] Обновить `docs/project.md` разделом об агенте
  - [ ] Настроить подтверждения и триггеры в агенте Cursor
  - [ ] Провести пробный прогон на последних изменениях
- **Зависимости**: Правила репозитория, формат документации
## Задача: Упростить шаблон государства (убрать хронологию из YAML)
- **Статус**: Завершена
- **Описание**: Удалить из YAML-блока шаблона государства поля history и population_history, оставить только текстовые секции для хронологии и динамики населения.
- **Шаги выполнения**:
  - [x] Удалить поля history и population_history из YAML
  - [x] Добавить пояснения в текстовые секции
- **Зависимости**: Нет

## Задача: Рефакторинг создания города
- **Статус**: Завершена
- **Описание**: Привести шаблон города и мастер создания города к единому стандарту (убрать поля history и population_history, добавить статические секции, обновить валидацию и шаги мастера).
- **Шаги выполнения**:
  - [x] Обновить шаблон Новый_город.md
  - [x] Обновить CityWizardModal.js
  - [x] Проверить управляющий шаблон Города.md
- **Зависимости**: Аналогичные задачи по государствам и провинциям

## Задача: Свободный ввод фракций
- **Статус**: Завершена
- **Описание**: В мастерах создания города и провинции выпадающий список фракций заменён на текстовое поле для свободного ввода.
- **Шаги выполнения**:
  - [x] Обновить CityWizardModal.js
  - [x] Обновить ProvinceWizardModal.js
- **Зависимости**: Аналогичные задачи для других сущностей (деревня и т.д.)

## Задача: Свободный ввод фракций для всех сущностей
- **Статус**: Завершена
- **Описание**: Во всех мастерах создания (деревня, замок, порт, монстр, народ, организация и др.) выпадающий список фракций заменён на текстовое поле для свободного ввода.
- **Шаги выполнения**:
  - [x] Обновить VillageWizardModal.js
  - [x] Обновить CastleWizardModal.js
  - [x] Обновить PortWizardModal.js
  - [x] Обновить MonsterWizardModal.js
  - [x] Обновить PeopleWizardModal.js
  - [x] Обновить OrganizationWizardModal.js
- **Зависимости**: Аналогичные задачи для новых сущностей в будущем

## Задача: Универсальный выбор проекта для всех мастеров
- **Статус**: Завершена
- **Описание**: Все мастера теперь при вызове вне проекта автоматически запрашивают проект, делают его текущим и продолжают работу только в рамках выбранного проекта.
- **Шаги выполнения**:
  - [x] Проанализировать текущую архитектуру вызова мастеров
  - [x] Вынести функцию ensureValidProjectRoot в EntityWizardBase
  - [x] Вызвать функцию во всех мастерах
  - [x] Протестировать на разных типах сущностей
- **Зависимости**: Обновление EntityWizardBase, ProjectSelectorModal, settingsService

## Задача: Руководство пользователя - создание сущностей
- **Статус**: Завершена
- **Описание**: Созданы главы руководства пользователя по созданию всех отлаженных сущностей (государство, провинция, город, деревня, замок, порт).
- **Шаги выполнения**:
  - [x] Создать главу "Создание государства"
  - [x] Создать главу "Создание провинции"
  - [x] Создать главу "Создание города"
  - [x] Создать главу "Создание деревни"
  - [x] Создать главу "Создание замка/фортификации"
  - [x] Создать главу "Создание порта"
  - [x] Обновить индексный файл руководства
- **Зависимости**: Аналогичные задачи для новых сущностей в будущем

## Задача: Обновление документации
- **Статус**: Завершена
- **Описание**: Исправлен индексный файл руководства пользователя и обновлена карточка функционала для соответствия реальности.
- **Шаги выполнения**:
  - [x] Убрать дублирование "Создание страны" и "Создание государства"
  - [x] Пометить планируемые разделы как "*в разработке*"
  - [x] Обновить карточку функционала с актуальными функциями
  - [x] Обновить changelog и tasktracker
- **Зависимости**: Регулярное обновление документации при изменениях функционала

## Задача: Исправление мастера деревни и фильтрации городов/деревень
- **Статус**: Завершена
- **Описание**: Исправить ошибку с обязательностью фракции, устранить ошибку this.data.date, добавить фильтрацию по тегу в Dataview-запросы для городов и деревень.
- **Шаги выполнения**:
  - [x] Сделать поле "фракция" опциональным в мастере деревни
  - [x] Исправить ошибку с this.data.date
  - [x] Добавить фильтрацию по тегу в Dataview-запросы
  - [x] Обновить changelog и tasktracker
- **Зависимости**: Нет

## Задача: Фильтрация государств и удаление валидации фракции в мастере деревни
- **Статус**: Завершена
- **Описание**: В мастере деревни фильтруются только настоящие государства (type: "Государство" или тег "государство"), валидация фракции полностью убрана.
- **Шаги выполнения**:
  - [x] Исправить функцию загрузки государств (фильтрация по type/tags)
  - [x] Убрать валидацию фракции
  - [x] Обновить changelog и tasktracker
- **Зависимости**: Нет

## Задача: Оптимизация вызова prepareXData в EntityFactory.js
## Задача: Исправление системы магии - наследование ArtifactWizardModal
- **Статус**: Завершена
- **Описание**: Исправить ошибку `this.createLoreAnalysisButton is not a function` при создании артефактов путем изменения наследования ArtifactWizardModal от EntityWizardBase.
- **Шаги выполнения**:
  - [x] Изменить наследование ArtifactWizardModal с HtmlWizardModal на EntityWizardBase
  - [x] Добавить импорт EntityWizardBase в ArtifactWizardModal.js
  - [x] Исправить импорт Modal в HtmlWizardModal.js
  - [x] Обновить changelog.md
- **Зависимости**: EntityWizardBase содержит метод createLoreAnalysisButton

## Задача: Починить регистрацию команды «Вставить сюжетную линию»
- **Статус**: Завершена
- **Описание**: Добавить алиас-команду `insert-plotline` на тот же колбэк, что и `insert-plotline-into-scene`, чтобы работали обе формулировки кнопок.
- **Шаги выполнения**:
  - [x] Зарегистрировать команду `insert-plotline` в `main.js`
  - [x] Обновить `docs/changelog.md`
  - [x] Проверить отсутствие линтер-ошибок
- **Зависимости**: Кнопки в шаблонах сцены и главы
- **Статус**: Завершена
- **Описание**: Заменить длинный switch-case на динамический вызов метода по имени (prepare${entityType}Data).
- **Шаги выполнения**:
  - [x] Удалить switch-case
  - [x] Внедрить динамический вызов метода
  - [x] Обновить changelog и tasktracker
- **Зависимости**: Нет

## Задача: Исправить поддержку директивы include в шаблонах
- **Статус**: Завершена
- **Описание**: Провести диагностику и устранить ошибку с неработающими директивами {{include:...}} в шаблонах при генерации сущностей через мастера. Добавлен временный вывод для отладки, после подтверждения работоспособности — удалён.
- **Шаги выполнения**:
  - [x] Добавить временный вывод результата _processIncludes в TemplateManager
  - [x] Провести тестирование генерации сущности (шахта)
  - [x] Убедиться, что директивы include заменяются корректно
  - [x] Удалить временный вывод
- **Зависимости**: src/TemplateManager.js, EntityFactory.js, мастера создания сущностей

## Задача: chapter_location_refactor
- **Статус**: Завершена
- **Описание**: Рефакторинг: определение папки главы теперь не зависит от выбора сюжетных линий. Глава всегда создаётся как контейнер (папка с файлом внутри). Если файл уже существует, он перезаписывается. В будущем аналогичная логика будет применяться к другим сущностям-контейнерам.
- **Шаги выполнения**:
  - [x] Рефакторинг определения папки главы
  - [x] Исправление логики создания файла внутри контейнера
  - [x] Добавление перезаписи файла при совпадении имён
  - [x] Документирование архитектурного решения
- **Зависимости**: нет

## Задача: Стандартизация кнопок мастеров (удаление инлайн-стилей)
- **Статус**: Завершена
- **Описание**: Во всех мастерах плагина инлайн-стили кнопок удалены, вместо них используются универсальные CSS-классы (`lt-btn`, `lt-btn-primary`, `lt-btn-success`, `lt-btn-outline`).
- **Шаги выполнения**:
  - [x] Найти все кнопки с style.cssText
  - [x] Удалить инлайн-стили для кнопок
  - [x] Добавить CSS-классы для всех кнопок
  - [x] Проверить единообразие внешнего вида
- **Зависимости**: Единый файл стилей styles.css

## Задача: Введение класса .lt-btn-wide для широких кнопок выбора
- **Статус**: Завершена
- **Описание**: Для всех кнопок выбора (главы, сцены и т.п.) добавлен CSS-класс `.lt-btn-wide`, инлайн-стили удалены, внешний вид централизован в CSS.
- **Шаги выполнения**:
  - [x] Добавить класс .lt-btn-wide в styles.css
  - [x] Найти все кнопки выбора с инлайн-стилями
  - [x] Удалить инлайн-стили, добавить классы lt-btn lt-btn-wide
  - [x] Проверить внешний вид во всех мастерах
- **Зависимости**: styles.css
