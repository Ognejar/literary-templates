# Карточка функционала: Новая_фортификация.md

## Общая информация
- **Файл**: `templates/Новая_фортификация.md`
- **Назначение**: Шаблон для создания фортификаций (замков, крепостей, фортов) в литературных проектах
- **Тип**: Военный шаблон локации
- **Зависимости**: `createCastle.js`, `CastleWizardModal.js`

## Структура шаблона

### Frontmatter
| Параметр | Тип | Описание | Пример |
|----------|-----|----------|--------|
| `created` | string | Дата создания | "2025-08-11" |
| `name` | string | Название фортификации | "Замок Торвальд" |
| `aliases` | array | Альтернативные названия | ["Замок Торвальд"] |
| `type` | string | Тип фортификации | "Замок" |
| `tags` | array | Теги для классификации | [place, фортификация] |
| `province` | string | Ссылка на провинцию | "Торвальд" |
| `state` | string | Ссылка на государство | "Королевство_1" |
| `country` | string | Ссылка на государство (дублирует state) | "Королевство_1" |
| `climate` | string | Климатическая зона | "Умеренный" |
| `dominantFaction` | string | Доминирующая фракция | "Аристократия" |
| `garrisonSize` | string | Размер гарнизона | "150 человек" |
| `garrisonTier` | string | Уровень гарнизона | "Средний" |

### Основной контент

#### Изображение
- **Параметр**: `{{imageBlock}}`
- **Описание**: Автоматически найденное изображение фортификации
- **Формат**: `![[путь_к_картинке]]`
- **Поиск**: В папке `Теговые_картинки` по типу фортификации (Замок, Крепость, Форт)

#### Заголовок и основная информация
- **Заголовок**: `{{castleName}}` - название фортификации
- **Тип**: `{{fortificationType}}` - тип фортификации (Замок/Крепость/Форт)
- **Климат**: `{{climate}}` - климатическая зона
- **Доминирующая фракция**: `{{dominantFaction}}` - основная фракция
- **Провинция**: `[[{{province}}]]` - ссылка на провинцию (условное отображение)
- **Гарнизон**: `{{garrisonSize}} (уровень {{garrisonTier}})` - размер и уровень гарнизона

#### Основные разделы
| Раздел | Параметр | Описание |
|--------|----------|----------|
| Описание | `{{description}}` | Подробное описание фортификации |
| Укрепления | `{{fortificationsContent}}` | Описание укреплений и оборонительных сооружений |
| Гарнизон (структура) | `{{garrisonContent}}` | Детальная структура гарнизона |
| Примечательные особенности | `{{notableFeaturesContent}}` | Уникальные особенности фортификации |

#### Автоматические связи
- **Фортификации в провинции**: `LIST FROM "" WHERE tags AND contains(tags, "фортификация") AND province = this.province`

## Параметры из createCastle.js

### Обязательные параметры
- `castleName` - название фортификации
- `fortificationType` - тип фортификации
- `climate` - климат
- `dominantFaction` - доминирующая фракция
- `state` - государство
- `description` - описание

### Опциональные параметры
- `province` - провинция
- `fortificationsContent` - описание укреплений
- `garrisonContent` - структура гарнизона
- `notableFeaturesContent` - примечательные особенности

### Автоматически генерируемые
- `date` - дата создания
- `projectName` - название проекта
- `imageBlock` - блок с изображением
- `garrisonSize` - размер гарнизона (автоматически рассчитывается по типу)
- `garrisonTier` - уровень гарнизона (автоматически определяется по типу)
- `country` - дублирует state для совместимости

## Интеграция с системой

### Связи с другими сущностями
- **Провинции**: Фортификация привязана к провинции через поле `province`
- **Государства**: Связь через поля `state` и `country`
- **Фракции**: Указана доминирующая фракция
- **Климаты**: Указан климат региона

### Dataview интеграция
- Автоматическое отображение других фортификаций в провинции
- Фильтрация по тегам и провинции
- Исключение текущего файла из списков
- Поддержка тегов для классификации

### Автоматический расчет гарнизона
- **Замок**: 100-200 человек (Средний уровень)
- **Крепость**: 200-500 человек (Высокий уровень)
- **Форт**: 50-100 человек (Низкий уровень)

## Пример использования

```javascript
// В createCastle.js
const data = {
    castleName: "Замок Торвальд",
    fortificationType: "Замок",
    climate: "Умеренный",
    dominantFaction: "Аристократия",
    state: "Королевство_1",
    province: "Торвальд",
    description: "Величественный замок на холме...",
    fortificationsContent: "- Высокие каменные стены\n- Ров с водой\n- Дозорные башни",
    garrisonContent: "- Командир гарнизона\n- 50 пехотинцев\n- 20 лучников\n- 10 рыцарей",
    notableFeaturesContent: "- Древний тронный зал\n- Потайные ходы\n- Сокровищница",
    date: "2025-08-11",
    projectName: "заявсь",
    garrisonSize: "150 человек",
    garrisonTier: "Средний",
    country: "Королевство_1",
    imageBlock: "![[Теговые_картинки/Замок.jpg]]"
};
```

## Особенности шаблона

### Унификация типов фортификаций
- Шаблон объединяет замки, крепости и форты в единую систему
- Автоматический расчет размера гарнизона по типу
- Поддержка быстрого создания через `quickType` параметр

### Условное отображение
- Провинция отображается только если указана: `{{#if province}}**Провинция:** [[{{province}}]]{{/if}}`
- Это позволяет создавать фортификации как с привязкой к провинции, так и без неё

### Военная направленность
- Шаблон специально адаптирован для военных сооружений
- Включает разделы для укреплений, гарнизона и оборонительных особенностей
- Автоматический расчет военного потенциала

### Гибкость создания
- Поддержка быстрого создания через контекстное меню
- Возможность создания как через мастер, так и быстрым способом
- Автоматическое заполнение параметров по типу

## История изменений
- **2025-01-09**: Интеграция с CastleWizardModal
- **2024-12-19**: Добавлена поддержка изображений через imageBlock
- **2024-12-19**: Унификация типов фортификаций
- **2024-12-19**: Добавлен автоматический расчет гарнизона
- **2024-12-19**: Создана первая версия шаблона

## Зависимости
- `createCastle.js` - логика создания
- `CastleWizardModal.js` - мастер ввода данных
- `settingsService.js` - получение настроек мира
- `Теговые_картинки/Замок.jpg` - изображение замка
- `Теговые_картинки/Крепость.jpg` - изображение крепости
- `Теговые_картинки/Форт.jpg` - изображение форта
