# Карточка функционала - Шаблон "Новый_город.md"

## Основная информация
- **Название**: Новый_город.md
- **Тип**: Шаблон для создания городов в мире
- **Путь**: templates/Новый_город.md
- **Версия**: 1.0.0
- **Статус**: Активен

## Описание функционала
Шаблон автоматически генерирует Markdown-файл города с полной структурой, включая метаданные, описание, районы, уникальные особенности и автоматические связи с другими сущностями мира.

## Параметры шаблона

### Основные параметры
| Параметр | Тип | Описание | Пример |
|----------|-----|----------|---------|
| `{{name}}` | string | Название города | "Новгород" |
| `{{type}}` | string | Тип поселения | "Город" |
| `{{climate}}` | string | Климатическая зона | "Умеренный" |
| `{{dominantFaction}}` | string | Доминирующая фракция | "Торговая гильдия" |
| `{{province}}` | string | Название провинции | "Северная провинция" |
| `{{country}}` | string | Название государства | "Русь" |
| `{{description}}` | string | Описание города | "Древний торговый город..." |
| `{{population}}` | string | Численность населения | "50000" |
| `{{mainIndustriesSection}}` | string | Основные отрасли | "- Торговля\n- Ремесла" |
| `{{districtsSection}}` | string | Описание районов | "- Кремль\n- Торговая площадь" |
| `{{uniqueFeaturesSection}}` | string | Уникальные особенности | "- Каменные стены\n- Подземные ходы" |

### Автоматически генерируемые
| Параметр | Тип | Описание | Источник |
|----------|-----|----------|----------|
| `{{date}}` | string | Дата создания | Текущая дата |
| `{{typeLower}}` | string | Тип в нижнем регистре | Автоматически из {{type}} |

## Условные блоки

### Изображения
```markdown
{{#if image:{{type}}}}
![{{type}}]([[img/{{type}}.jpg]])
{{/if}}
```
- **Условие**: Существует изображение для типа поселения
- **Результат**: Вставка изображения из папки img/

### Население и отрасли
```markdown
{{#if population}}
## Население
- **Численность:** {{population}}
{{#if mainIndustriesSection}}
- **Основные занятия:** {{mainIndustriesSection}}
{{/if}}
{{/if}}
```
- **Условие**: Указана численность населения
- **Результат**: Отображение секции населения с основными занятиями

### Основные отрасли
```markdown
{{#if mainIndustriesSection}}
## Основные отрасли
{{mainIndustriesSection}}
{{/if}}
```
- **Условие**: Указаны основные отрасли
- **Результат**: Отображение секции с описанием отраслей

### Районы и особенности
```markdown
{{#if districtsSection}}
## Районы
{{districtsSection}}
{{/if}}

{{#if uniqueFeaturesSection}}
## Уникальные особенности
{{uniqueFeaturesSection}}
{{/if}}
```
- **Условие**: Указаны районы или уникальные особенности
- **Результат**: Отображение соответствующих секций

### Провинция
```markdown
{{#if province}}**Провинция:** [[{{province}}]]{{/if}}
```
- **Условие**: Указана провинция
- **Результат**: Отображение ссылки на провинцию в основной информации

## Автоматические связи

### Обитатели
```dataview
LIST FROM #people OR #character
WHERE (
    contains(file.outlinks, [[{{name}}]]) OR
    contains(file.tags, "{{name}}") OR
    regexmatch(file.text, "#{{name}}") OR
    regexmatch(file.text, "\\[\\[{{name}}(\\||\\]\\])")
) AND file.name != this.file.name
```

### Соседние локации
```dataview
LIST FROM #place
WHERE (
    (contains(file.outlinks, [[{{name}}]]) OR
     contains(file.tags, "{{name}}") OR
     regexmatch(file.text, "#{{name}}") OR
     regexmatch(file.text, "\\[\\[{{name}}(\\||\\]\\])"))
    AND file.name != this.file.name
)
```

## Структура генерируемого файла

### Frontmatter
- `created`: Дата создания
- `name`: Название города
- `aliases`: Псевдонимы
- `type`: Тип поселения
- `climate`: Климат
- `tags`: Теги для категоризации
- `dominantFaction`: Доминирующая фракция
- `province`: Провинция
- `country`: Государство

### Основной контент
1. **Заголовок** с названием города
2. **Основная информация** в виде таблицы
3. **Описание** города
4. **Районы** с детальным описанием
5. **Уникальные особенности**
6. **Автоматические связи** (обитатели и соседние локации)

## Интеграция с системой

### Создание через модальное окно
- **Файл**: CityWizardModal.js
- **Функция**: createCity()
- **Путь сохранения**: `{проект}/Локации/Города/{название}.md`

### Валидация данных
- Проверка обязательных полей
- Очистка названия от спецсимволов
- Автоматическое формирование sections из массивов

### Обработка шаблона
- Функция: `generateFromTemplate()`
- Поддержка условных операторов
- Автоматическая замена плейсхолдеров

## История изменений

### [2025-01-09] - Создание шаблона
- Добавлен базовый шаблон города
- Реализованы условные блоки для изображений
- Добавлены dataview запросы для автоматических связей
- Интеграция с системой создания сущностей

## Зависимости
- **Плагин**: Literary Templates
- **Модальное окно**: CityWizardModal
- **Функция создания**: createCity()
- **Система шаблонов**: generateFromTemplate()

## Технические особенности
- Поддержка кириллицы в UTF-8
- Автоматическое создание папок
- Интеграция с Obsidian Dataview
- Условная обработка изображений
- Автоматические ссылки на связанные сущности

# Карточка функционала

## Общие секции для всех документов
| Секция | Описание | Условие отображения |
|--------|----------|---------------------|
| Шапка | Изображение + заголовок документа | `{{#if tagImage}}` для изображения |
| Описание | Основное описание сущности | `{{#if description}}` |
| Магические свойства | Список магических способностей | `{{#if magicalProperties}}` |
| Ограничения | Ограничения использования | `{{#if limitations}}` |
| Риски | Потенциальные опасности | `{{#if risks}}` |
| Особенности | Уникальные характеристики | `{{#if featuresContent}}` |
| Способ создания | Метод изготовления | `{{#if creationMethod}}` |
| Обслуживание | Требования по уходу | `{{#if maintenance}}` |
| История | Происхождение и события | `{{#if history}}` |
| Владение и расположение | Владелец и местонахождение | `{{#if ownerText}}`, `{{#if locationText}}` |

### История изменений
- **2025-08-13**: Создана система общих секций для всех типов документов
- **2025-08-13**: Секция "Шапка" вынесена в отдельный файл для переиспользования
- **2025-08-13**: Устранено дублирование кода секций между разными типами сущностей
- **2025-08-13**: Техническое обслуживание — обновлён основной модуль плагина (`main.js`): добавлен DocBlock и устранены предупреждения линтера

# Карточка функционала: Хранение настроек через отдельный файл

## Описание
Плагин хранит все пользовательские настройки в отдельном файле `.obsidian/plugins/literary-templates/settings.json`. Это позволяет избежать ошибок ранней инициализации и даёт пользователю возможность вручную редактировать настройки через команду "Открыть настройки Literary Templates".

## Параметры
- `aiKeys`, `currentKeyIndex`, `keyUsage`, `aiEnabled`, `defaultModel`, `maxTokens`, `temperature` и др.

## Возвращаемое значение
- Объект настроек, загружаемый из JSON-файла.

## Примеры использования
```js
this.settings = await loadSettingsFromFile(this.app);
await saveSettingsToFile(this.app, this.settings);
```

## История изменений
- 2025-07-20: Введено хранение настроек через отдельный файл и команда открытия настроек.

| Функция | Описание | Статус |
|---|---|---|
| Свободный ввод фракций | Для всех сущностей (город, деревня, провинция, замок, порт, монстр, народ, организация и др.) фракции теперь задаются свободным текстовым вводом, без ограничений на глобальный справочник. | Внедрено |
| Руководство пользователя | Созданы главы руководства по созданию всех отлаженных сущностей (государство, провинция, город, деревня, замок, порт) с пошаговыми инструкциями. | Внедрено |
| Рефакторинг шаблонов | Убраны поля history и population_history из YAML в шаблонах города, государства, провинции. Добавлены статические секции для хронологии и динамики населения. | Внедрено |
| Управляющие шаблоны | Созданы шаблоны для индексных файлов (Локации.md, Персонажи.md, Сюжетные_линии.md, Замки.md) с Dataview-запросами и кнопками создания. | Внедрено |
| Индексация фортификаций | Добавлен тег "фортификация" в шаблон Новый_замок.md, создан индексный файл Замки.md для отображения всех фортификаций проекта. | Внедрено |
| Рефакторинг инфраструктуры | Исправлены теги и структура шаблонов ферм, шахт и заводов. Созданы индексные файлы для инфраструктурных объектов. Обновлены мастера для свободного ввода фракций. | Внедрено |

# Карточка функционала: Универсальный выбор проекта для всех мастеров

## Основная информация
- **Название**: Универсальный выбор проекта
- **Тип**: Базовая функция для всех мастеров
- **Путь**: EntityWizardBase.js, ProjectSelectorModal.js
- **Версия**: 1.0.0
- **Статус**: Активен

## Описание функционала
Любой мастер создания сущности (город, шахта, ферма, завод, провинция, государство, замок и др.), вызванный вне проекта, автоматически запрашивает проект через ProjectSelectorModal. После выбора проект становится текущим для плагина, и мастер продолжает работу только в рамках выбранного проекта.

## История изменений
- 2025-09-06: Внедрён универсальный механизм выбора проекта для всех мастеров.

## VillageWizardModal.js (деревня)
- Теперь в список государств попадают только настоящие государства (type: "Государство" или тег "государство").
- Валидация фракции полностью убрана, поле всегда опционально.
- Статус: Внедрено

## VillageWizardModal.js и фильтрация городов/деревень
- Исправлено: поле "фракция" теперь опционально, устранена ошибка с this.data.date.
- Улучшено: Dataview-запросы для городов и деревень теперь фильтруют только по тегу, что исключает лишние файлы из индексов.
- Статус: Внедрено

## EntityFactory.js: оптимизация вызова prepareXData
- Вместо switch-case теперь используется динамический вызов метода по имени (prepare${entityType}Data).
- Код проще для поддержки и расширения.
- Статус: Внедрено