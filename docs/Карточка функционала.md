# Карточка функционала - Шаблон "Новый_город.md"

## Основная информация
- **Название**: Новый_город.md
- **Тип**: Шаблон для создания городов в мире
- **Путь**: templates/Новый_город.md
- **Версия**: 1.0.0
- **Статус**: Активен

## Описание функционала
Шаблон автоматически генерирует Markdown-файл города с полной структурой, включая метаданные, описание, районы, уникальные особенности и автоматические связи с другими сущностями мира.

## Параметры шаблона

### Основные параметры
| Параметр | Тип | Описание | Пример |
|----------|-----|----------|---------|
| `{{name}}` | string | Название города | "Новгород" |
| `{{type}}` | string | Тип поселения | "Город" |
| `{{climate}}` | string | Климатическая зона | "Умеренный" |
| `{{dominantFaction}}` | string | Доминирующая фракция | "Торговая гильдия" |
| `{{province}}` | string | Название провинции | "Северная провинция" |
| `{{country}}` | string | Название государства | "Русь" |
| `{{description}}` | string | Описание города | "Древний торговый город..." |
| `{{population}}` | string | Численность населения | "50000" |
| `{{mainIndustriesSection}}` | string | Основные отрасли | "- Торговля\n- Ремесла" |
| `{{districtsSection}}` | string | Описание районов | "- Кремль\n- Торговая площадь" |
| `{{uniqueFeaturesSection}}` | string | Уникальные особенности | "- Каменные стены\n- Подземные ходы" |

### Автоматически генерируемые
| Параметр | Тип | Описание | Источник |
|----------|-----|----------|----------|
| `{{date}}` | string | Дата создания | Текущая дата |
| `{{typeLower}}` | string | Тип в нижнем регистре | Автоматически из {{type}} |

## Условные блоки

### Изображения
```markdown
{{#if image:{{type}}}}
![{{type}}]([[img/{{type}}.jpg]])
{{/if}}
```
- **Условие**: Существует изображение для типа поселения
- **Результат**: Вставка изображения из папки img/

### Население и отрасли
```markdown
{{#if population}}
## Население
- **Численность:** {{population}}
{{#if mainIndustriesSection}}
- **Основные занятия:** {{mainIndustriesSection}}
{{/if}}
{{/if}}
```
- **Условие**: Указана численность населения
- **Результат**: Отображение секции населения с основными занятиями

### Основные отрасли
```markdown
{{#if mainIndustriesSection}}
## Основные отрасли
{{mainIndustriesSection}}
{{/if}}
```
- **Условие**: Указаны основные отрасли
- **Результат**: Отображение секции с описанием отраслей

### Районы и особенности
```markdown
{{#if districtsSection}}
## Районы
{{districtsSection}}
{{/if}}

{{#if uniqueFeaturesSection}}
## Уникальные особенности
{{uniqueFeaturesSection}}
{{/if}}
```
- **Условие**: Указаны районы или уникальные особенности
- **Результат**: Отображение соответствующих секций

### Провинция
```markdown
{{#if province}}**Провинция:** [[{{province}}]]{{/if}}
```
- **Условие**: Указана провинция
- **Результат**: Отображение ссылки на провинцию в основной информации

## Автоматические связи

### Обитатели
```dataview
LIST FROM #people OR #character
WHERE (
    contains(file.outlinks, [[{{name}}]]) OR
    contains(file.tags, "{{name}}") OR
    regexmatch(file.text, "#{{name}}") OR
    regexmatch(file.text, "\\[\\[{{name}}(\\||\\]\\])")
) AND file.name != this.file.name
```

### Соседние локации
```dataview
LIST FROM #place
WHERE (
    (contains(file.outlinks, [[{{name}}]]) OR
     contains(file.tags, "{{name}}") OR
     regexmatch(file.text, "#{{name}}") OR
     regexmatch(file.text, "\\[\\[{{name}}(\\||\\]\\])"))
    AND file.name != this.file.name
)
```

## Структура генерируемого файла

### Frontmatter
- `created`: Дата создания
- `name`: Название города
- `aliases`: Псевдонимы
- `type`: Тип поселения
- `climate`: Климат
- `tags`: Теги для категоризации
- `dominantFaction`: Доминирующая фракция
- `province`: Провинция
- `country`: Государство

### Основной контент
1. **Заголовок** с названием города
2. **Основная информация** в виде таблицы
3. **Описание** города
4. **Районы** с детальным описанием
5. **Уникальные особенности**
6. **Автоматические связи** (обитатели и соседние локации)

## Интеграция с системой

### Создание через модальное окно
- **Файл**: CityWizardModal.js
- **Функция**: createCity()
- **Путь сохранения**: `{проект}/Локации/Города/{название}.md`

### Валидация данных
- Проверка обязательных полей
- Очистка названия от спецсимволов
- Автоматическое формирование sections из массивов

### Обработка шаблона
- Функция: `generateFromTemplate()`
- Поддержка условных операторов
- Автоматическая замена плейсхолдеров

## История изменений

### [2025-01-09] - Создание шаблона
- Добавлен базовый шаблон города
- Реализованы условные блоки для изображений
- Добавлены dataview запросы для автоматических связей
- Интеграция с системой создания сущностей

## Зависимости
- **Плагин**: Literary Templates
- **Модальное окно**: CityWizardModal
- **Функция создания**: createCity()
- **Система шаблонов**: generateFromTemplate()

## Технические особенности
- Поддержка кириллицы в UTF-8
- Автоматическое создание папок
- Интеграция с Obsidian Dataview
- Условная обработка изображений
- Автоматические ссылки на связанные сущности
