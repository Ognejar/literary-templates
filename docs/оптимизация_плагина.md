# Возможные оптимизации плагина Literary Templates

На основе анализа кода и архитектуры плагина, вот основные направления для оптимизации：

## 1. Производительность и узкие места

### Оптимизация загрузки конфигурации

- **Проблема**: В `CityWizardModal.loadConfig()` происходит синхронная загрузка всех провинций и стран при открытии модального окна
- **Решение**:
  - Использовать асинхронную загрузку с индикатором прогресса
  - Реализовать кэширование конфигураций между сессиями
  - Загружать только необходимые данные для текущего шага

### Оптимизация фильтрации провинций

- **Проблема**: Метод `filterProvincesByState` в `EntityWizardBase` читает содержимое каждого файла провинции для определения принадлежности государству

- **Решение**:
  - Создать индекс провинций по государствам при инициализации проекта
  - Использовать метаданные из frontmatter без полного чтения файлов
  - Реализовать кэширование результатов фильтрации

### Оптимизация работы с файлами

- **Проблема**: Многократные вызовы `app.vault.getAbstractFileByPath()` для одних и тех же путей
- **Решение**:
  - Реализовать кэш файловых объектов
  - Использовать batch-операции для работы с группами файлов

## 2. Архитектурные улучшения

### Улучшение системы шаблонов

- **Проблема**: Жесткая привязка к определенным именам полей в шаблонах
- **Решение**:
  - Создать систему маппинга полей с возможностью настройки
  - Реализовать валидацию шаблонов на этапе сборки
  - Добавить поддержку вложенных шаблонов и наследования

### Модульность AI сервисов

- **Проблема**: AI сервисы глобально доступны через window, что затрудняет тестирование и замену
- **Решение**:
  - Внедрить систему зависимостей (dependency injection)
  - Создать интерфейсы для AI сервисов
  - Реализовать фабрики сервисов с возможностью подключения различных провайдеров

### Улучшение системы событий

- **Проблема**: Некоторые события обрабатываются синхронно, что может блокировать UI
- **Решение**:
  - Реализовать асинхронную систему событий
  - Добавить приоритеты событий
  - Создать систему отмены длительных операций

## 3. Пользовательский интерфейс

### Улучшение мастеров создания

- **Проблема**: Все мастеры имеют фиксированную ширину 900px, что может быть неудобно на разных экранах
- **Решение**:
  - Реализовать адаптивный дизайн с медиа-запросами
  - Добавить возможность изменения размера окон
  - Создать компактный режим для небольших экранов

### Улучшение навигации

- **Проблема**: Навигация по шагам мастера линейная, без возможности перехода к определенному шагу
- **Решение**:
  - Добавить интерактивный индикатор прогресса с возможностью перехода между шагами
  - Реализовать валидацию шагов при переходе вперед/назад
  - Добавить возможность сохранения промежуточных результатов

### Улучшение обработки ошибок

- **Проблема**: Ошибки отображаются через Notice, что не всегда удобно для пользователя
- **Решение**:
  - Создать централизованную систему уведомлений с различными уровнями важности
  - Добавить возможность просмотра деталей ошибок
  - Реализовать автоматическую отправку отчетов об ошибках (с согласия пользователя

## 4. Расширение функциональности

### Улучшение системы тегов

- **Проблема**: Текущая система тегов ограничена и не позволяет создавать сложные связи
- **Решение**:
  - Реализовать иерархические теги
  - Добавить поддержку пользовательских атрибутов тегов
  - Создать визуальный редактор тегов

### Расширение AI функциональности

- **Проблема**: AI функции доступны только для ограниченного набора сценариев
- **Решение**:
  - Создать систему AI плагинов с возможностью подключения внешних сервисов
  - Реализовать контекстное меню AI действий
  - Добавить поддержку batch обработки нескольких файлов

### Улучшение системы импорта/экспорта

- **Проблема**: Импорт фактов из буфера обмена ограничен по форматам
- **Решение**:
  - Добавить поддержку различных форматов (CSV, XML, JSON с разной структурой)
  - Реализовать визуальный предпросмотр перед импортом
  - Создать систему шаблонов импорта для различных источников

### Расширение возможностей Dataview интеграции

- **Проблема**: Текущие Dataview запросы ограничены и не используют полный потенциал
- **Решение**:
  - Создать генератор Dataview запросов с визуальным интерфейсом
  - Добавить поддержку сложных фильтров и сортировок
  - Реализовать пользовательские функции для Dataview

## 5. Дополнительные улучшения

### Локализация

- Добавить поддержку нескольких языков
- Создать систему локализации с возможностью пользовательских переводов

### Документация и обучение

- Создать интерактивные туториалы
- Добавить встроенную документацию с примерами
- Реализовать систему подсказок контекста

### Профили пользователей

- Создать систему профилей с разными настройками
- Реализовать возможность обмена профилями между пользователями

Эти оптимизации позволят значительно улучшить производительность, расширить функциональность и сделать плагин более удобным для пользователей.

## 6. Оптимизация по принципам DRY, KISS и SRP

### DRY (Don't Repeat Yourself)

#### Уже реализовано

- **`getContentTypeByName`**: Создана вспомогательная функция для устранения дублирования логики определения типа контента по имени файла.

#### Предложения

- **`addContextMenu`**: Метод `addContextMenu` (начиная со строки 3108) содержит значительное дублирование кода при создании пунктов меню. Каждый пункт меню создается почти идентичным образом, с небольшими различиями в параметрах (заголовок, иконка, обработчик клика). Это можно улучшить, создав вспомогательные методы, например, `_addContextMenuItem` или `_addContextMenuCategory`.
- **`registerCommands`**: Метод `registerCommands` (начиная со строки 3079) также содержит дублирование при регистрации команд. Каждая команда регистрируется с помощью почти идентичного шаблона. Это тоже можно улучшить, создав вспомогательную функцию.
- **`getRecommendationsForType`**: Метод `getRecommendationsForType` (строки 4727-4882) содержит большой объект с рекомендациями. Его можно вынести в отдельный константный объект или JSON-файл для лучшей читаемости и поддержки.

### KISS (Keep It Simple, Stupid)

#### Предложения1 (с учетом ограничений сборки в один файл)

- **`addContextMenu`**: Метод `addContextMenu` чрезвычайно сложный и длинный (более 400 строк). Его можно значительно упростить, разбив на более мелкие методы или используя конфигурационный подход.
- **`onload`**: Метод `onload` также очень сложный и длинный. Его можно разбить на более мелкие методы.
- **`getRecommendationsForType`**: Метод `getRecommendationsForType` содержит большой объект с рекомендациями. Его можно вынести в отдельный константный объект или JSON-файл для лучшей читаемости.

### SRP (Single Responsibility Principle)

#### Предложения по рефакторингу (с учетом ограничений сборки в один файл)

- **`LiteraryTemplatesPlugin`**: Класс `LiteraryTemplatesPlugin` серьезно нарушает SRP. Он отвечает за слишком много различных аспектов функциональности плагина.
  - Инициализация и жизненный цикл плагина (`onload`, `onunload`, `constructor`).
  - Работа с редактором Obsidian (`getActiveEditor`, `insertTodoAtCursor`, `insertPlotlineIntoScene`).
  - Работа с проектами (`chooseProjectRoot`, `editWorldSettings`, `_selectProjectParentFolder`).
  - Работа с шаблонами (`readTemplateFile`, `applyTemplate`, `processConditionalBlocks`, `evaluateCondition`, `processIncludeBlocks`).
  - Работа с AI (`aiAnalyzeAndExtendNote`, `aiBuildLoreContext`, `aiGatherProjectLore`, `aiAppendCurrentNoteLore`, `testAIConnection`, `showDiagnostics`, `openAIKeysManager`, `retryAIInitialization`, `createSafePluginContext`).
  - Работа с файлами и папками (`ensureEntityInfrastructure`, `safeCreateFile`, `logDebug`).
  - Работа с базой фактов (`loadFacts`, `saveFacts`, и т.д. - хотя эти функции определены глобально, они тесно связаны с плагином).
  - Регистрация команд и контекстного меню (`registerCommands`, `addContextMenu`).
  - Вспомогательные функции (`prompt`, `suggester`, `selectProject`, `getPromptFiles`, `showPromptSelector`, `parsePromptYaml`, `getRecommendationsForType`).
  Это делает класс очень тяжелым для понимания, тестирования и поддержки.
  
  **Решение (с учетом ограничений сборки в один файл):**
  - **Внутри класса**: Разбить функциональность на более мелкие методы, каждый из которых отвечает за одну конкретную задачу, как уже упоминалось выше для KISS. Это поможет частично соблюсти SRP, даже если класс остается монолитным.
    - Все методы, связанные с AI, можно сгруппировать и назвать с префиксом `_ai*` (например, `_aiAnalyzeNote`, `_aiBuildLoreContext`).
    - Все методы, связанные с проектами, можно сгруппировать с префиксом `_project*` (например, `_projectSelectRoot`, `_projectEditSettings`).
    - Все методы, связанные с шаблонами, можно сгруппировать с префиксом `_template*` (например, `_templateReadFile`, `_templateApply`).
    - Все методы, связанные с контекстным меню, можно сгруппировать с префиксом `_contextMenu*` (например, `_contextMenuAddStoryItems`, `_contextMenuAddLocationItems`).
    - Все методы, связанные с регистрацией команд, можно сгруппировать с префиксом `_command*` (например, `_commandRegisterEntityCreators`, `_commandRegisterAIHelpers`).
